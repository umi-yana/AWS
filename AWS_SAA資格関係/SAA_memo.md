# 資格対策

AWSの考えるベストプラクティス
AWS Well-Architectedフレーム（AWSによる優れた設計フレームワーク）の５本の柱

1. 運用
2. セキュリティ
3. 信頼性
4. パフォーマンス 
5. コスト

# リージョンとアベイラビリティゾーン

- リージョン
    - AWSがサービスを提供している拠点のことを指す。各リージョンは地理的に離れて設置されている。
- アベイラビリティゾーン
    - リージョン内に複数のデータ保管する場所のことを示す

### 信頼性について

- 地理的/電気的に独立した場所に設置されている。
- 洪水や地震などの局地的な災害を考慮して、別のAZに影響が内容な場所に設置されている。
- 電気的独立として、AZすべてのデータセンターが一斉にダウンすることがないように設計されている。

### マルチAZ

単一のAZでは、オンプレのシステム構築していた場合と耐久性はそれほど変わらないため、同一リージョンで複数のAZでシステム構築すること

---

# VPC（Amazon Virtual Private Cloud)

```yaml
利用者ごとのプライベートなネットワークをAWS内に作成すること
```

### インターネットゲートウェイ(IGW)

インターネット側に出口をつけることにより、直接インターネットに出て行くことが可能になる

### 仮装プライベートゲートウェイ(VGW)

オンプレの拠点を出口として、専用線のサービスであるVPN経由で直接的にインターネットに出ることなく、各拠点との接続が可能

`注意点`

S3やCloudWatch、DynamoDBなどは、VPC内に入れないサービスであるため注意が必要

### IPアドレス

```yaml
VPCには制作者が自由なIPアドレス（CIDRブロック）をアサインすることができる。
```

そのため、あたかも自社ネットワークの一部であったような振る舞いができる。

CIDRブロックは/16か/28の範囲で作成することができる。

可能な限りネットワーク空間の大きい(/16)で作成し、IPアドレスの不測を補う

### サブネット

```yaml
EC2インスタンスなどを軌道するためにVPC内部に作るアドレスレンジ
（大きなネットワークを分割した際の、それぞれの小さいネットワーク）
```

1. サブネットを設置するCIDRブロックのサイズはVPCと同様/16ー/28まで
2. サブネット作成時にAZを指定する。作成後の変更不可
3. サブネットごとにルートテーブルを１つだけ指定する
4. サブネットごとにネットワークACLを１つだけ指定する
5. １つのVPCで作れるサブネットの数は200個
6. サブネットの最初の４つ及び最後の１つのアドレスは予約されていて、使用できない
7. 必要以上にサブネットを分割することはアドレスの浪費に繋がる
8. サービスの中にはIPアドレスの確保が必要なサービスがある。

重要な点

```yaml
ここのサブネットには一つの仮装ルータがあり、この仮装ルータが
ルートテーブルとネットワークACLの設定を持っており、
サブネット内のEC2インスタンスのデフォルトゲートウェイになっている
```

サブネット作成時に同一の役割を持ったサブネットを複数のAZに作ることで、AZの障害に対してる良い設計をすることができる。

---

### ルートテーブル

VPC内部への通信やインターネットやオンプレネットワーク基盤などの外部への通信を実装する

- ここのサブネットに１つずつ設定する
- １つのルートテーブルに複数のサブネットを共有することができるが１つのサブネットに複数のルートテーブルは繋ぐことはできない
- 宛先アドレスとターゲットとなるゲートウェイを指定する
- VPCにはメインルートがあり、サブネット作成時に指定していないとデフォルトのルートテーブルになる。

---

### セキュリティグループ

```yaml
**EC2やELBなどのインスタンス単位で通信制御に利用する。**
インスタンスは少なくとも１つのセキュリティグループをアタッチする必要がある。
```

通信の制御として

インバウンド（内向きから外部からVPC）とアウトバウンド（外向き、内部から外部へ）の両方の制御が可能。

制御範囲

プロトコル（TCP,UDP）とポート範囲、送受信先のCIDRかセキュリティグループを指定する。

デフォルトはアクセス拒否となり、設定された項目のみアクセス許可がある。

### ネットワークACL（アクセスコントロールリスト）

```yaml
**サブネットごとに通信制御に利用する。**
制御できる項目はセキュリティグループと同様でインバウンド/アウトバウンドの制御が可能
```

送受信先にはセキュリティグループを指定できない。

デフォルトではすべての通信を許可になっている。

ポイント

```yaml
セキュリティーグループはインスタンス単位の通信制御に使用し、
ネットワークACLはサブネットごとの通信制御に利用する。
```

---

## ゲートウェイ

```yaml
ゲートウェイはVPCの内部と外部のやり取りをする出入口
```

### インターネットゲートウェイ（IGW)

```yaml
インターネットとを接続するためのゲートウェイ
```

各VPCに１つだけアタッチメントできる。

IGW自体には設定項目は何もない、また障害が起こった際もAWS側が自動的に復旧してくれる。

### 仮想プライベートゲートウェイ（VGW)

```yaml
VPCがVPNやDirect Connectと接続するためのゲートウェイ
```

VGWも各VPCに１つだけアタッチメントできる

ルートテーブルがVGWをターゲットに指定するとその宛先アドレスとの通信はVGWから、VPNを通してオンプレネットワークに基盤に向けられる。

宛先については、ルートテーブルに静的に記載する方法とルート伝播で動的に反映する方法がある。

**重要ポイント**

```yaml
・ゲートウェイはVPCの内部と外部との通信をやり取りする出入口
・VPCとインターネットを接続するゲートウェイはインターネットゲートウェイ（IGW）
・VPCとVPNやDirect Connectとの接続は仮想プライベートゲートウェイ（VGW）
```

---

## VPCエンドポイント

VPC内からインタネット上のSWAサービスに接続する方法は２通りある

1. インターネットゲートウェイを利用する方法
2. VPCエンドポイントと呼ばれる特殊なゲートウェイを使用する方法。

VPCエンドポイントはS3やDynamoDBと接続する際に利用するゲートウェイエンドポイントと

それ以外の多数のサービスと接続するインターフェイスエンドポイント（AWS PrivateLink)がある

### ゲートウェイエンドポイント

ルーティングを利用したサービス。エンドポイントを作成し、S3などとの接続はインターネットゲートウェイを使用せず、エンドポイントを利用して行われる。

セキュリティ的にもVPCエンドポイントは重要で、経路の安全性を問われる場合、インターネットを経由しないことが求められる場合が多いので、その際にVPCエンドポイントは有効。

---

### ピアリング接続

```yaml
	２つのVPC間でプライベートな接続をするための機能
```

同一AWSアカウントのVPC間のみならず、AWSアカウントをまたがっての接続も可能

VPCピアリングでの通信相手はEC2インスタンスなどで、PGWなどとの接続はできない。

---

### VPCフローログ

VPC内の通信解析に使用する。

記録される内容は送信元、送信先アドレス・ポート、プロ所番号、データ量と許可・拒否の区別

---

## Direct Connect と Direct Connect Gateway

### Direct Connect

```yaml
AWSとオフィスやデータセンターなどの物理拠点とを専用回線で繋げない場合に使用する
```

VPNに比べて遅延やパケット損失率が低下し、スループットが向上するなど安定したネットワークが利用できる。
大量のデータをやり取りする場合や、ネットワーク品質にこだわる場合はDirect Connectを利用する。

### Direct Connect Gateway

```yaml
1つのDirect Connectで複数のAWSアカウントやVPCに接続することができる。
```

---

### Cloud Front

```yaml
HTMLやCSS、画像といった静的コンテンツをキャッシュし、
オリジナルサーバーの代わりに配信するCDNサービス

本体のサーバーまでアクセスするのは、物理的にも時間が要するため
アクセスした人に物理的に地下場所に設置されてキャッシュサーバに
本体サーバのキャッシュを保存しておくことで、アクセスの応答速度を早めることができる。
```

注意点

CDNのためバックエンドサーバー（オリジナルサーバが必要）

オリジナルサーバとしては、ELB、EC2,S3などが利用できる。

またオンプレサーバーを指定することも可能なため、システム構築をする必要はなく、Cloud Frontを導入することで、一時的なアクセスなどにも対応可能。

### ディスリビューションの種類

`ダウンロードディストリビューション`

HTTPやHTTPSを使ってHTML,CSS,画像などのデータを配信する際に使用

`ストリーミングディストリビューション`

RTMPを使い、動画のストリーミング配信をする際に利用する。

キャッシュルール

```yaml
拡張子やURLバスごとにキャッシュ期間をしてすることができる。
例）あまり変更しない内容はキャッシュ期間を長くする
```

`注意点`

仮に誤った画像などをアップロードしてしまった場合は、オリジナルサーバ側の更新はもちろんだが、`CDN側のキャッシュクリア`も行わないといけない

### まとめ

```yaml
・静的コンテンツをキャッシュし、オリジナルサーバの代わりに配信するCDNサービス
・バックエンドにはELBやS3などの静的ホスティング、またはオンプレサーバが利用できる
・ダウンロードディストリビューションは画像などを配信する際に使用、
　ストリーミングディストリビューションは動画をストリーミング配信する際に使用
・キャッシュ期間を拡張子、ファイルパスごとに設定できる。

```

---

Route 53

```yaml
ドメイン管理機能と権威DNSを持つサービス。WebコンソールやAPIから、
簡単にドメイン情報やゾーン情報を設定できるサービス
```

ドメインやDNSの情報を管理するだけでなく、ネットワークトラフィックのルーティングや状況に応じた接続先に変更などの機能を持っている。

### ドメイン管理

新規のドメイン取得や更新などの手続きができるサービス

そのため一貫した管理が可能で、料金もAWS利用料金に含まれるため、更新忘れなどのリスクを回避できる。

### 権威DNS

DNSはドメイン名とIPアドレスを変換してくれるサービス

Route53は権威DNSでドメイン名とIPアドレスの変換情報を保持しているDNSのことで、変更情報を保持していないDNS（キャッシュDNS）を区別するときに使う。

ホストとレコードの情報

ホストゾーンとは、レコード情報の管理単位を表す

- レコード情報とは
    - 例）192.168.000.000　= www.test.com　といったドメイン名とIPアドレスの変換するための情報
    - レコード情報には
        - Aレコード
        - MXレコード
        - CNAMEレコード
        - Aliasレコード（Route 53で特徴的なレコード）
            - DNSクエリに対するレスポンスが高速
            - CNAMEにマッピングできないZoneApex（ドメイン名そのもの）を設定可能
            - ALIASレコードに対するクエリが無料Route 53と連携したDNS Lookupの高速化
            

### トラフィックルーティング

Route53にゾーン情報を登録する際に、名前解決の問い合わせに対してどのように応答するか決めるルーティングポリシーが存在する

1. シンプルルーティングポリシー
    1. 特殊なルーティングポリシーを使わずに、標準的な１on1のルーティング
2. フェールオーバールーティング
    1. アクティブ・スタンバイ方式でアクティブ側のシステムが失敗した際に、スタンバイ側のシステムにルーティングするポリシー
    2. 本番システム障害時にSorrを表示するサーバーのIPアドレスをセカンダリーレコードとしておくことで、自動的にSorrを表示するサーバーを表示することができる。
3. 位置情報ルーティングポリシー
    1. ユーザの位置情報に基づてトラフィックルーティングする際に使用する。例えば日本からのアクセスは日本語コンテンツのWebサーバに接続するなど
4. 地理的接近性ルーティング
    1. リソースの場所に応じてトラフィックルーティングし、必要に応じて別のリソースに移動する
5. レイテンシールーティングポリシー
    1. 複数のサーバが分散されている場合、遅延が最も少ないサーバにリクエストをルーティングする。特定サーバーだけ高負荷になった場合にリクエストを分散することができる。
6. 複数値回答ルーティングポリシー
    1. １つのレコードに異なるIPアドレスを複数登録して、ランダムに返却されたIPアドレスに接続する。チェックでNGになったIPアドレスは返却されないため、自動的に正常に稼働しているサーバにルーティングされる。
7. 加重ルーティングポリシー
    1. 指定した比率で複数のリソースにトラフィックをルーティングする際に使用する。
    2. 拠点がまたがったリソースの異なるサーバが配置されている場合、リクエスト比率を調整する。

### トラフィックフロー

ルーティングポリシーを組み合わせることで、様々なルーティング環境を構築することができる。

各レコード間の設定が複雑になることがあるので、組み合わせビジュアル的にもわかりやすく組み合わせるためのツールを使って定義できる。

## DNSフェイルオーバー

Route53が持つフォールトトレラントアーキテクチャ（システムの一部に問題が生じても全体が機能停止するということなく（たとえ機能を縮小にしても）動作し続けるシステムのこと）

DNSフェイルオーバーをしようすることで

稼働中にシステム障害が発生しても、一時的にSorrryを表示するサーバに切り替えるてくれる。

### まとめ

```yaml
・Route53は、ドメイン管理機能と権威DNS機能を持つサービス
・７種類のルーティングポリシーがあり、これらを組み合わせることで様々なルーティング環境を構築できる。
・障害を最小限に抑えるためのフォールトトレラントアーキテクチャとして、DNSフェイルオーバが存在する。

```

---

# AWSにおけるコンピューティングサービス

### コンピューティングサービス

```yaml
アプリケーションを稼働させるインフラストラクチャサービス
```

### EC2

- 仮想サーバを提供するコンピューティングサービス。必要な数だけすぐにサーバを立てることができる。
- ELBやAuto Scalingといったサービスを組み合わせることで、負荷に応じた動的サーバーの台数を変更することもできる。
- インスタンスという単位でサーバーが管理される。
- オンプレに比べて、サーバ調達LTが短い。また必要最小限のコストで始めることができる。
- リリース後想定よりも人気が出た場合などはインスタンスの種類や数を増やすことで、対応することができる。
- EC2を起動するときいは、元となるイメージを選んでインスタンスを作成する。このイメージをAmazon Machine Image（AMI）と呼ぶ
- AMIはRed HadやUbuntuなどAWSが標準として提供しているものや、各ベンダーがサービスをプリインストールしたAMIもある。

### まとめ

```yaml
EC2を使うとサーバーインスタンスの個数や性能を柔軟に変更できる、コスト削減や時間短縮が実現できる。
```

### 性能について

インスタンスのスペックを選択することができる。　＝　インスタンスタイプ

```yaml
`m5.large` ` p3.8xlarge`
```

- 先頭のmやpはインスタンスファミリーを表し、何に最適化をしているインスタンスかを意味する。
    
    c  = コンピューティングに最適化
    
    r = メモリに比重を置く
    
- インスタンスファミリーの後は世代を表す
    
    数字が大きいものが最新となる。
    
- large　などはインスタンスサイズを表し、大きいものほどスペックが高いインスタンスタイプになる。

### EBS

```yaml
インスタンス性能は決める要素とディスク機能
```

EC2では通常の通信で使用するネットワーク帯域とEBSとのやり取りで利用する帯域を共有している。そのため、ディスクI/O、外部とのリクエストともに多く発生する場合、帯域が足りなくなってしまうことがある。

EBS最適化インスタンスのオプションを有効にすると、通常のネットワーク帯域とは切り離し、EBS用の帯域が確保される。

なおEBSインスタンスはある程度大きめのインスタンスタイプでしか利用できない。

### EC2の費用

EC2はインスタンスを使った分だけ課金される従量課金製

- インスタンスがRunning状態だった時間
    - 起動中（Running）、停止（Stopped）、削除済み（Terminated）の３つが存在する
    - Stopped、Terminatedは課金対象にならない
    - ただ、EBSは停止中のインスタンスでも課金対象になるので注意が必要
- Running状態だったインスタンスのタイプ、AMI、起動リージョン

スポットインスタンスとリザーブインスタンス

通常はオンデマンドインスタンスだが、スポットインスタンスとリザーブインスタンスという利用オプションがある。

### スポットインスタンス

AWSが余らせてるEC2リソースを入札形式で安く利用する方法。ただ、ほかの利用者が増え、この余ったリソースがなくなったら中断してしまうこともある。（機械学習でデータ学習などの一時的な利用にメリットアリ）

### リザーブドインスタンス

長期利用を約束することで割引を受けられるオプション

（サービスをリリースした後にインスタンスタイプを固定できると思ったら利用する。）

### インスタンスの分類と用途

- 汎用
    - 一番利用範囲が広くCPUとメモリのバランス型（M5や T3）
- コンピューティング最適化
    - CPUの性能が高いもの（C5などのC系統）
- メモリ最適化
    - メモリ容量の大き物（R5やX1）
- 高速コンピューティング
    - GPUなどのCPU以外の計算リソースが強化されている。
        - 画像処理系はP系
        - 機械学習系はG系
- ストレージ最適化
    - HDDを利用するD2
    - SSDを利用するI3
    
    ### Savings Plans
    
    ```yaml
    インスタンスの利用数ではなく、インスタンスの利用額に対してコミットする
    ```
    
    Computer Savings Plans
    
    - リージョンやインスタンスファミリと関係なく、すべてのインスタンスをを対象に単位時間あたりに利用料を指定して購入する。
    
    スケジュールされたリザーブドインスタンス
    
    - １年のうち毎日、毎週、毎月の一定時間のみ使うというパターンで利用料金を削減することができる。
        - 対象のインスタンスはC3,C4,M4,R3 (最新のインスタンスには対応していない）
        

---

## ELB

```yaml
単一のインスタンスで運用を続けるとある特定の部分が停止してしまう場合、単一障害点となってします。
そのため、EC2を複数並べて対策するが、その処理を並列に行うためのロードバランサーのこと
```

スケールアウト

```yaml
EC2のインスタンスを複数用意して、それらに分散負荷することで高負荷に耐える対応を
スケールアウトという
```

### ELCの種類

- **Classic Load Balancer(CLB)**
    - L4/L5レイヤーでの負荷分散を行う
    - リスナー範囲が広い
    - 課金対応がデータ転送（GB
- **Application Load Balancer（ALB)**
    - L7レイヤーで負荷分散を行う。CLBよりも機能は豊富
    - 複数ポートを個別ターゲットとして登録することが可能なのでECSなどのコンテナでロードバランシングができる。
    - ターゲットグループでのヘルスチェックが可能
    - EC2と同様に削除保護が可能
    - 荷重ロードバランシングが可能
    - リクエスト内容によって分散先を振り分けることができる。
    - URLのパスに基づいてルーティングが可能
- **Network Load Balancer(NLB)**
    - L4レイヤーでの負荷分散を行う。HTTP以外のプロトコル通信の負荷分散をしたい時に利用
    - ALBよりも高パフォーマンス処理が可能
    - サブネットを使うことができる。
- **Gataway Load Balancer（GLB)**
    - サードパーティ製のアプリケーションをVPCにデプロイ、スケーリング、管理するためのELB
    

CLBとALBは同じアプリケーションレイヤーでの負荷分散を行うが、ALBのほうがコストも安く、機能も豊富

NLBはHTTP以外のTCPプロトコルの負荷分散を行うために使用される。

ロードバランサ自体が固定のIPアドレスを持つなどの特徴がある。

### ELBの特徴

- ELB自体が負荷に応じて自動的にスケールする設定となっている。
    - インスタンスに限らず、IPアドレスをターゲットにした分散も可能
    - 負荷に応じてキャパシティを自動増減可能（AWS側が管理）
- ただ、スケーリングは瞬時に完了するわけではないので、急激な負荷増（スパイク）が予想される場合は、ELBプレウォーミングを申請し、その時間に合わせて、ELBをスケールした状態にすることができる。
- ヘルスチェック機能
    - ELB配下のEC2にリクエスと送り、各インスタンスが正常に動作しているか確認する機能
        - もし異常なインスタンスが発見された場合は自動的に切り離し、その後正常動作が確認できた場合は紐づける。
- パブリック・プライベートどちらでも使用可能
- クロスゾーン負荷分散
    - 配下の複数のAZにいるEC２に均等に分散
- 時間時応じたロードバランサーキャパシティで課金される
- スティキーセッション
    - 同じユーザからのリクエストを継続して同じインスタンスに振り分ける
        - なお、均等にならないためエラーになりやすい
- Connection Draining
    - インスタンスが登録解除されたり、異常発生した場合、バックエンドインスタンスへの新規通信を中止する。
    - 異常が発生した場合、S3などのファイルにアクセスするような場合につかう
- HTTPSやTLS通信
    - ELBに設定することで対応できる。
- Auto Scaling,Route 53,Cloud Formationなどと連携できる
- ログ取得
    - ELBのログ取得を有効化するとS3バケットにログを収集できる。
    

## Auto Scaling

システムの利用状況に応じて自動的にELBに紐づくインスタンスの台数を増減させる機能

**設定する内容**

- 最小のインスタンス数
- 最大のインスタンス数
- インスタンスの数を増やす条件（例　CPU使用率が80%になったらインスタンス２台増やす）
- インスタンスの数を減らす条件

Auto Scalingを利用することで必要な時にインスタンスを増やすなどの柔軟な運用をすることがきる。

また障害耐性を高めることができる。あるインスタンスで問題があった場合、ヘルスチェックで切り離すことができ、その後Auto Scaling機能で新しい正常なインスタンスを紐づけることができる。

**設定プロセス**

1. ELBのターゲットグループの作成
2. 起動設定・テンプレートの作成
3. Auto Scalingグループの作成（閾値やスケーリング方式などの設定）

### スケーリングポリシー

Auto Scalingのスケーリングは以下の３つの方法がある

- **動的なスケーリング**
    - 簡易スケーリング
        - CPU使用率の閾値を超えた時に動作する（現在は非推奨）
    - **ステップアップスケーリング**
        - 複数の閾値を設定することができ、段階的に設定することができる。
        - １つの閾値でも設定可能なので、簡易スケーリングの上位互換
    - **ターゲット追跡スケーリング**
        - CloudWatchのモニタリングメトリクスを使用して目標値を設定し、CPU使用率が一定になるように自動的に調整してくれる。
        - 今後はターゲット追跡スケーリングが主流になる
- **予測スケーリング**
- **スケジュールスケーリング**

Auto Scalingを使って需要に応じて、インスタンス増減を行うと立ち上げ中に新たなインスタンスを立ち上げることを抑止する必要がある。

### ヘルスチェック

Auto Scaling配下のEC2のヘルスチェックにはEC2ステータス情報またはELBのヘルスチェックのどちらかを使用する。

- EC2ステータスでヘルスチェック
    - インスタンスがRunnig以外を異常と判断する
- ELB
    - ELBのヘルスチェックを利用して、ヘルスチェックとする方法
- CloudWatch
    - CloudWatchのアラートを利用してヘルスチェックとする方法

### 猶予期間(クルーダウンとクールアップ）

```yaml
インスタンスを立ち上げるには起動時間などの時間が必要となる。その起動時間中にヘルスチェックでエラーが出続けると想定したスケーリング動作にならないので、行って期間ヘルスチェックを行わないようにする猶予期間を設定する。
```

`注意`

GUIからの設定はデフォルト300秒だが、CLIやSKDから作った場合はデフォルトが0秒なので注意が必要。

**クールダウン**

- Auto Scalingが発動した直後に追加でインスタンスの増減が行われるのを防ぐための設定
- クールダウンの期間はデフォだが、変更することも可能

`注意点`

- なお、ダウン期間中にスケジュールされたインスタンス追加などがある場合は、クールダウンを待たずに実施される。
- インスタンスが異常で止まった場合は、クールダウン関係なく異常があるインスタンスを削除する。

**ウォームアップ**

- インスタンスが最も少ないAZでインスタンスを起動する
- インスタンスが立ち上がらん場合は、起動が成功するまで別のAZで実行する。
- AZでアンバランスが発生した場合
    - 不均衡なインスタンスやインスタンス数があると自動的に不足しているAZに振り分ける
    - 古いインスタンスが終了する前に新しいインスタンスを起動することで、パフォーマンスの低下を防ぐ
    - Auto Scalingの最大容量を超えると完全停止するので、多少多めに容量を設定しとくことが大事

## そのほかのオプション

### ライフサイクルフック

Auto Scalingグループによるインスタンスの起動または削除時にインスタンスを一時停止してカスタムアクションを実行する機能

起動時にデータを取得したり、削除時にログやデータを退避する処理の追加といった用途で使用することができる。

待機時間はデフォルトで最大48h

---

### 終了ポリシー

```yaml
負荷が下がってインスタンスを減らす場合（スケールイン）Auto Scalingでどのインスタンスを削除するかを決めるのが終了ポリシー
```

デフォルトはAZに均等に配分されるように削除する

| 終了ポリシー | 動作 |
| --- | --- |
| Oldestinstance | 最も古いインスタンスを削除 |
| Newestinstance | 最も新しいインスタンスを削除 |
| OldesttLaunchConfiguration | 最も古い起動設定のインスタンスを削除 |
| ClosestToNextinstanceHour | 次の課金時間に最も近いインスタンスを削除 |
| Default | AZ間の台数に均等に保つように削除 |
| OldestLaunchTemplate | 最も古い起動テンプレートを使用するインスタンスを削除 |
| AllocationStrategy | スポットまたはオンデマンドなどのインスタンスタイプによって削除 |

ウォームアップとクールダウン　＝　インスタンスの増減時のアクション

猶予期間　＝　ヘルスチェック時のアクション

終了ポリシー　= Auto Scalingの機能

---

### ELBとAuto Scalingを利用する際の設計ポイント

- サーバーをステートレスに、つまり状態を保持しないように設計すること
    - 起動したインスタンスの中にファイルを格納するのではなく、S3やDBなどに格納し
    
    　　Auto Scalingなどでインスタンスが削除されても、データが残るようにする。
    
- AZをまたがってインスタンスを配置する設計にすべき
    - AZ全体で障害が発生する場合がり、１つのAZに固まってしまうと全てのインスタンスが利用できなくなるため、複数のAZにインスタンスを構築する。

### まとめ

```yaml
いかに単一障害点をなくし、部分部分の障害は起こり得ることを前提として設計する。
```

---

### Amazon Elastic Container Service（ECS）

```yaml
Dockerコンテナ環境を提供するサービス。
ECSはDocker環境に必要な設定が含まれたEC2インスタンスが起動し、その管理をサポートする。
```

EC2インスタンス上で起動されるコンテナのことを`Task`と呼ぶ

EC2インスタンス上のことを`Cluster（クラスター）`

Cluster上で動作するTaskの定義は`Task Definition（タスク デフィ二ション）`

同じTaskを複数用意したい場合は、`Service（サービス）`を使用する

Serviceは「webサーバー用のTask DefinitionでTaskを４つ起動する」といった指定ができる。

またAuto Scalingを使用して、動的にスケーリングをする指定も可能

### AWS上のその他のコンテナサービス

ECS以外にもAWSには下記コンテナ関連のサービスがある。

1. AWS Fargate
    1. EC2を使わずにコンテナを動かすことができるサービス。Clusterの管理が必要ない。コストは各タスクに割り当てるCPUとメモリに応じて決まる
2. Amazon Elastic Container Service for Kubernetes（EKS）
    1. Kubernetesを使用して、EC 2インスタンスを複数台を自動的に立ち上げることができ、マスター用のインスタンスを起動する必要がなくなった。
3. Amazon Elastic Container Registry（ECR)
    1. Dockerのコンテナイメージをレジストリで管理する必要があった。自前で運用する場合、レジストリ自体の可用性を高める設計が必要となる。このレジストリの管理とレジストリへのPush/pull権限をIAMで管理することも可能

## Lambada

サーバーをプロビジョニングしなくてもプログラムを実行することができるコンピュータサービス

- サーバーレスアーキテクチャの中核を担う存在。
- EC2上でソースコードを動かすには、インスタンスを作成し、各種ソフトウェアを導入するなど手間が掛かる。
- Lambdaを使用するとソースコードの実行環境一式が提供されているため、利用者はソースコードだけを用意すればすぐにプログラムを実行できる。
- リクエストの数に応じて、自動的にスケールするので、処理に必要なサーバーの台数を考える必要がない。
- サーバーを持たないので、パッチ当てなどの保守作業もいらない

### Lambda関数

```yaml
実行するプログラムとその実行トリガーとなるイベントを事前定義する
そのイベントが発生した際にプログラムが実行される。
```

- S3バケットにオブジェクトが追加された時または削除された時
- DynamoDBが更新された時
- SESがメールを受信したとき
- API GatewayへのHTTPリクエストがあったとき

など

### Lambdaがサポートしているプログラミング言語

- Python
- Node.js
- Ruby
- PowerShell
- C#
- Java
- Go

Pythonでは初回Lambda起動までの時間が短い傾向

Javaは初回起動までの時間が長いが処理は早い

### 言語以外に定義できる設定

- 割り当てるメモリ量
- タイムアウトまでの時間
- Lambdaに割り当てるIAMロール
- VPC内で実行するかVPCの外で実行するか

### Lambdaの料金体型

- Lambda関数の実行数
- 100万回のリクエストにつき、0.2USD
- Lambda関数の実行時間：Lambda関数ごとに割り当てたメモリ量によって単位課金が決まる。

### まとめ

```yaml
・　プログラムの実行環境を提供し、インフラの構築や管理にかける時間を減らせる
・　リクエスト量に応じて自動的にスケールする
・　リクエスト量や処理時間に応じた課金モデルが採用されている
・　Lambdaから他のAWSサービスに接続する場合は、Lambda関数に適切なIAMロールを割り当てる必要がある。
```

---

# AWSにおける運用支援

### Amazon CloudWatch

```yaml
　運用監視を視点するマネージドサービス
 定期的にAWSリソースの状態を取得し、問題がある場合はそれを利用者に通知するサービス
```

　

- 何が問題があるかとする利用者側でエラー内容を定義することができる
- アプリケーションのログ監視や独自のトリガーを定義して、そのトリガーが発生したら後続の処理を行う機能も提供されている。

中核となる３つの機能

- **CloudWach**
`メトリクス` = 各AWSリソースの状態を定期的に取得する
    
    `標準メトリクス` = EC2インスタンスのCPU使用率など、AWS側が事前に定義しているメトリクス
    
    `カスタムメトリクス` = ユーザ側が定義したCloud Watchに渡すことで、独自のメトリクスを作る
    
    このメトリクスを使用することで、アラームを定義することができる
    
    Ex) EC2インスタンスのCPU利用率が８０％を超えた場合、Cloud Watchが発火し、SNSに情報を渡すなど
    
- **CloudWach Logs**
    
    ```yaml
    アプリケーションログやApacheログなどのログをモニタリングするサービス
    ```
    
    `注意点`
    
    - 利用するには独自のエージェントをインストールする必要がある。
    - 送信元のインスタンスにCloud WatchのIAM権限を付与する必要があるので、IAMロールで設定が必要
    
    CloudWach Logsは収集したログに対してアラームを設定することができる。
    
    収集したログに[ERROR]から始まった行があったときに発火する
    
    収取したログに[WARN]から始まる行が一定期間に３行あったら発火するなど
    
- **CloudWach Events**
    
    ```yaml
    独自のトリガーと何かしらの継続アクションとの組み合わせを定義するサービス
    ```
    
    1. イベントソース　= 独自のトリガー
        1. スケジュール　…３時間おきなどといった一定期間、時間ベースのトリガー
        2. イベント　… Auto Scalingがインスタンスを増減させたらなどのAWSリソースの状態変化がトリガー
    2. ターゲット　＝　継続アクション
        1. AWSリソースに対するアクションを定義する
        2. １つのイベントリソースに対して複数のターゲットを定義することも可能。
        
    
    まとめ
    

### まとめ

```yaml
CloudWatchのメイン機能はAWSリソースの状態を定期的に取得する
CloudWatch Logsは、アプリケーションログやApacheログなどのログをモニタリングするサービス
CloudWatch Eventsは、独自のトリガーと何かしらのアクションを組み合わせて定義するサービス
```

### AWS CloudTrail

```yaml
AWSリソースの作成や、マネージメントコンソールへのログインなどを操作を記録するサービス
だれがいつどのような操作をしたかといった監査ログを記録しておくことで、
　大規模障害やセキュリティインシデントを対策する
```

- 一部操作についてはデフォルトで記録されているが、設定を変更することですべての操作を記録することができる。
- S 3にログを残す機能も提供されており、そのログをそのまま監査ログにすることもできる。

取得できる操作には下記の２種類が存在する。

- **管理イベント**
    - マネジメントコンソールへのログイン、EC2インスタンスの作成
    - 管理イベントの取得のみがデフォルトで有効となっている。
- **データイベント**
    - S3バケット上のデータ操作、Lambda関数の実行など
    - データイベントの取得はデフォルトではないので、設定が必要
    

管理イベントの取得のみがデフォルトで有効となっている。

90日分のログをマネジメントコンソール上で取得できる。

90日以上のログはS3に保存するように設定できる。

### CloudWatch Logsとの連携

CloudWatch Logsで事前に不正操作を登録しておき、

AWS CloudTrailで操作logを取得した際にCloudWatch Logsで不正操作内容があった場合は発火するように設定

この設定をすることで、インシデントに繋がる操作を早期に発見することができる。

---

## AWSのストレージサービス

分類

- ブロックストレージ
    
    ```yaml
    データを物理的なディスクにブロック単位で管理するストレージ
    頻繁に更新されたり、高速なアクセスが必要な際に使われる
    
    記憶領域をボリュームという単位に分割し、ブロック単位で呼び出すストレージ
    人が直接扱うというよりは、OSが管理するようなストレージ
    ```
    
    対象：Amazon EBS
    

- ファイルストレージ
    
    ```yaml
    ブロックストレージ上にファイルシステムを構築して、データをファイル単位で管理するストレージ
    複数のクライアントからネットワーク経由でファイルにアクセスするといったデータ共有のために
    使われている。
    
    データをファイルとフォルダという階層構造で管理
    ```
    
    使用例
    
    複数のクライアントからネットワーク経由でファイルにアクセスするといったデータ共有のために使われている
    
    過去データをまとめて保存したりといった用途で使われている。
    
    対象
    
    Amazon EFS
    
- オブジェクトストレージ
    
    ```yaml
    ファイルに任意のメタデータを追加して、オブジェクトとして管理するストレージ。
    ファイルの内容をストレージ内で直接操作することはできず、作成したデータに対して
    HTTP経由で登録、削除、参照することが可能
    
    データをオブジェクトという単位で扱うストレージ
    ```
    
    管理方法
    
    オブジェクトを一意に認識するIDとそれを管理するメタデータで構成されている。
    
    ファイルストレージのように階層的な構造ではなく、フラットな構造のため、拡張性が高い。
    
    使用例
    
    更新頻度の少ないデータや大容量マルチメディアコンテンツを保存する用途で使われる。
    
    対象
    
    S3,S3 Glacier
    
- FSx
    
    ```yaml
    フルマネージドなファイルストレージ。
    ```
    
    - **FSx for Windowsファイルサーバー**
        - Windowsのファイルサーバーとして使うことができる。
        - WIndows server 上に構築されるので、Windowで使われるユーザークォータなど幅広い利用が可能。
        - Window Updateや各種パッチ当てなどのメンテナンスはAWS側が行う。
    - **FSx for Luster**
        - フルマネージドな分散ファイルシステムでS3とシームレスに統合できる。
        1.  Lusterはファイルシステム作成時にS3のバケットと関連付けをする。
        2. S3上のファイルをインデックスし、あたかも自前のファイルのように見せる
        3. 初回はS3から取得してくるので、遅いが２回目以降はキャッシュしているので、高速
        4. 高速なデータアクセスが必要なハイパパフォーマンスコンピュータに使用され、機械学習やビックデータ処理などに使われる。

### まとめ

|  | ブロックストレージ | ファイルストレージ | オブジェクトストレージ |
| --- | --- | --- | --- |
| 管理単位 | ブロック | ファイル | オブジェクト |
| データライフサイクル | 追加、更新、削除 | 追加、更新、削除 | 追加、削除 |
| プロトコル | SATA、SCSI、FC | CIFS,NFS | HTTP |
| メタデータ | 固定情報のみ | 固定情報のみ | カスマイズ可能 |
| ユースケース | データベース、トランザクションログ | ファイル共有、データアーカイブ | マルチメディアコンテンツ、データアーカイブ |

```yaml
AWSでは、EBS,EFS,S3,S3 Glacier,Storage Gatewayという５つのストレージサービスが提供されている。

このうち、EBSはブロックストレージ
EFSはファイルストレージ
S3,S3 Glacierはオブジェクトストレージとして分類されている。
```

---

## EBS

```yaml
EC2のOS領域として利用したり、追加ボリュームとして複数のEBSをEC2にアタッチすることもできる
```

- RDSのデータ保存ようにも使用できる。
- EBSは作成時にAZを指定するため、指定したAZで作成されたEC2インスタンスからのみアタッチ可能
- 異なるAZからEC2インスタンスに接続したい場合は、EBSのスナップショットを取得して、スナップショットから指定のAZでEBSボリュームを作成することでアタッチ可能になります。

### ボリュームタイプ

EBSのボリュームタイプはSSDタイプが２種類、HDDタイプが２種類

- 汎用SSD(gp2)
    
    ```yaml
    EBSの中で最も一般的なSSDベースのボリュームタイプ
    デフォルトのボリュームタイプ
    ```
    
    - 性能の指標としてIOPS（１秒間に処理できるI/Oアクセスの数）を使用し、容量に応じたベースライン性能がある。
    - 1TB未満のボリュームには一時的なIOPS上昇に対応できるようバースト機能が用意されている。（max 3000IOPS)
    
- プロビジョンドIOPS SSD(io1）
    
    ```yaml
    EBSの中でも最も高性能なSSDをベースにしたボリュームタイプ
    RDSやEC2インスタンスでデータベースサーバーを構築する場合など、高いIOPSが求めらる際に利用される。
    ```
    
    IOPSの負荷が高いユースケースと高いスループットが必要なユースケースの両方に適したストレージタイプ
    
    ストレージ容量に応じてベースラインの性能はない
    
- スループット最適化HDD(st1)
    
    ```yaml
    HDDをベースとしたスループット重視のボリュームタイプ
    ```
    
    - ログデータに対する処理やバッチ処理のインプット用ファイルなど、大容量ファイルを高速に読み取るようなユースケースに適している。
- Cold HDD(sc1)
    
    ```yaml
    ストレージの性能は高くないが、最も低コストなボリュームタイプ
    ```
    
    利用頻度があまりなく、アクセス時の性能も求められていない場合に適している。
    

`注意点`

- EBSへのアクセス最適化が可能なEC2インスタンスを利用がおすすめ
- 旧世代のマグネティックと呼ばれるHDDのストレージタイプもあるが新規で作成するときは、原稿のボリュームタイプから最適なものを選ぶ

### ベースライン性能とバースト性能

- プロビジョニンドIOPS以外のストレージはベースライン性能がある。
- 処理量の一時的増加に対応可能なバースト性能もあり、一時的に処理量を増やすものなので、
    
    これに頼った設計はしない。
    

## EBSの拡張・変更

### 容量拡張

- すべてのタイプのEBSは１ボリュームあたり最大容量が16TB
- ディスク容量が不足したら必要に応じてサイズを何度でも拡張することができる。

`注意点`

**拡張はできるが縮小はできない。**

一時的に容量増加は、ボリューム拡張ではなく、新規のEBSを作成し、EC2インスタンスに紐付け、不要になればEBSごとデタッチする

### ボリュームタイプの変更

IOPSが不足することがわかったボリュームタイプを変更することもできる。

`注意点`

- プロビジョンドIOPSタイプで指定したIOPS値については増減どちらも変更可能
- IOPSの変更には最大24時間以上かかる場合がある。変更期間中はボリュームのステータスが「Modifying」になっている。ステータスが「Complete」になっていれば完了

### EBSの可用性・耐久性

EBSは内部的にAZ内の複数の物理ディスクに複製が行われる、AWS内で物理的な故障が発生した場合でも利用者は意識することはほとんどなく、自動的に変更される。

EBSにはスナップショット機能もあるため、定期的にバックアップを取得することで必要な時点の状態に戻すこともできる。

EBSは**内部的に冗長化**されており、一般のハードディスクに比べて信頼性は高いが、壊れないわけではないので、スナップショットやバックアップを取る運用設計が必要。

### EBSのセキュリティ

ストレージ自体を暗号化するオプションがある。暗号化を有効化するとボリュームが暗号化されるだけでなく、スナップショットも暗号化される。

暗号化の処理はEC2インスタンスが稼働するホストで実施されるため、EBS間をまたぐデータ通信時のデータも暗号化された状態になる。

すでに作成済みのEBSボリュームを暗号化したい場合は、以下の手順を踏む

1. EBSボリュームのスナップショットを取得
2. スナップショットを暗号化
3. 暗号化されたスナップショットから新規EBSボリュームを作成
4. EC2インスタンスにアタッチしているEBSボリュームを入れ替え

Amazon EBSマルチアタック

```yaml
複数のインスタンスから同一のEBSをアタッチできる。
```

`注意点`

同一のAZのインスタンスからのみアタッチ可能で、別AZからはできない

プロビジョンド IOPS SSDボリュームのみ対応可能

---

### EFS

```yaml
容量無制限で複数のEC2インスタンスから同時にアクセスが可能なファイルストレージ
```

クライアントからEFSへの接続は、一般的なNFSプロトコルをサポートしているため、NFSクライアントさえあれば特別なツールをインストールしたり設定したりする必要はない。

amazon-efs-utilsツールを使うと、EFSへのマウントに関する推奨オプションが含まれていたり、ファイルシステムにトラブルが発生した場合のトラブルシューティングに役立つログが記録できたりする。

### EFSの構成要素

- ファイルシステム
- マウントターゲット
- セキュリティーグループ

EFSはファイルが作成されると自動的に３箇所以上のAZに保存される分散ファイルシステムを構築する。

作成したファイルシステムにアクセスするために、AZごとにサブネットを指定してマウントターゲットを作成する。

マウントターゲットを作成すると、ターゲットポイント（接続FQDN)が１つと各AZのマウントターゲット用IPアドレスが発行される。

### EFSパフォーマンスモード

1. 汎用パフォーマンスモード
    1. ほとんどの場合は、汎用パフォーマンスモードを使えば問題ない
2. 最大I/Oパフォーマンスモード
    1. 数百〜数千台といったクライアントから同時にEFSへアクセスがあるようなユースケースにも耐えらるように用意されている。

どちらのモードを選択すればいいかはCloud Watchの**PercentOLimit**というメトリクスが参考にする。

性能テスト時に**PercentOLimitが長い時間高い状況（80-100％）である場合は、最大I/O パフォーマンスモードに変更した方が良い場合がある。**

なおパフォーマンスモードは後から変更できないので、導入前によく検討しておかなくてはいけない。

### EFSのスループットモード

EFSにはパフォーマンスモードとは別に２つのスループットモードが用意されている。

- バーストスループットモード
    - EFSに保存されているデータ容量に応じてベースラインとなるスループットが設定される。（一時的なスループットの上昇にも耐えられるようなバースト機能を持ったモード）
- プロビジョニングスループットモード
    - バーストスループットモードで設定されているベースラインスループットを大幅に超える、または、一時的なバースト時にバーストスループットで定められている最大スループットよりも高い性能が必要な場合に、任意のスループット値を指定することができる。
    - データサイズがそれほど大きくないものの、頻繁にアクセスしたり大量のインスタンスから同時アクセスを受けるようなデータをEFSに配置する場合に最適。
    

どちらのスループットモードを選択すれば良いかを見極める指標として、Cloud WatchのBurstCreditBalanceというメトリックが参考になる。

---

### Amazon S3（Simple Storage Service)

```yaml
非常に優れて耐久性を持つ、容量無制限のオブジェクトストレージサービス
```

- ディレクトリ構造を持たないフラットな構造であること
- ユーザが独自にデータに対して情報（メタデータ）を付与することができる
- RESTやSOAP といったHTTPをベースとしたWebAPIを使ってアクセスする。
- EBSスナップショットの保存場所として使われる

### ユースケース

- データバックアップ
- ビックデータ解析用などのデータレイク
- ETLの中間ファイル保存
- Auto Scaling構築されたEC2インスタンスやコンテナからのログ転送先
- 性的コンテンツのホスティング
- 簡易的なKey-Value型のデータベース

**大容量・長期保存・なくなると困る**　といったデータが対象となる。

### S3の構成要素

- バケット
    - オブジェクトを保存するための領域。バケット名はAWS内で一意にする必要がある。
- オブジェクト
    - S3に格納されたデータそのもの。各オブジェクトにはキーが付与され（バケット名＋キー名＋バージョンID）で必ず一位になるURLが作成される。
        
        このURLをWebAPIなどで指定してオブジェクト操作をする。
        
    - １つのオブジェクトは最大5TBまで
- メタデータ
    - オブジェクトを管理するための情報。オブジェクトの作成日時やサイズなどのシステム定義メタデータだけでなく、アプリケーションに必要な情報をユーザー定義メタデータとして保持することもできる。
    

### S3の耐久性と整合性

```yaml
S3で保存されたデータは、複数のAZ,AZ内の複数の物理ストレージに複製される。
そのため高い耐久性が維持される。
```

S3は結果適合性方式を採用しており、呼び出したタイミングによっては前のデータが表示されることもある。

### ストレージグラス

S3には高い耐久性があるが、そのお用途によって5つのランク分がされている。

- **S3標準**
    - デフォルトのストレージクラス。低レイテンシーと高いスループットを兼ね備えている。
- **S3標準ー低頻度アクセス**
    - S3標準に比べて格納コストが安価なストレージクラス。参照頻度の低いデータ向けに設定されたクラス。データアクセスは随時可能だが、データの読み出し容量に対する従量課金。それほど頻繁にアクセスしないデータを保存するのに最適
- **S3 １ゾーン−IA**
    - 単一のAZ内のみでデータを複製するストレージクラス。
    - AZ内の障害でデータが復旧できない可能性がある。
- **S3 Intellgent Tiering**
    - 参照頻度の高低を明確に決めることができないデータを扱う場合に有効なストレージクラス。
    - S3標準とS3標準ー低頻度アクセスの２層構造となっており、30日以上参照されなかったデータは自動的にS3標準ー低頻度アクセスに移動される。頻繁に移動する場合は、コスト高になる。
- **S3 	Glacier**
    - ほとんど参照されないアーカイブ目的のデータをほぞんするストレージクラス。
    - オブジェクト新規作成時にこのクラスを選択することはできない
    - S3 Glacier以外のストレージクラスを選択して、ライフサイクル管理をつかってこのストレージを指定することで利用可能になる。
    - S3 	Glacierにアクセスする場合は、事前にアクセスをリクエストする必要があり、アクセスできるようになるまでには数時間かかる。
- **S3 Glacier Deep Archive**
    - S3 	Glacierよりもさらにアクセスされないストレージクラス
    - データの取り出しは１２時間以内。ただ、GBあたりのストレージ単価は低く、S3 	Glacierに比べて最大75％安い

### ライフサイクル管理

S3に保存されたオブジェクトは利用頻度に応じて、ライフサイクルを定義することができる。

その場合、どちらかを選択できる。

- 移行アクション
    - データの利用頻度に応じて、ストレージクラスを変更するアクション
        
        一定期間過ぎると利用頻度や重要性は低くなり、最後にはアーカイブとして保存しておくといったライフサイクルに応じて、ストレージクラスを変更することができる。
        
- 有効期限アクション
    - 指定された期限を超えたオブジェクトをS3から削除するアクション。
    - 利用期限が決まっているオブジェクトや一時的に作成されたオブジェクトなどを定期的に整理/削除することができる。不要なデータを削除することでコスト削減が測れる
    

### バージョニング機能

- 有効にすると１つのオブジェクトに対して複数のバーションを管理することができる。
- バージョニングはバケット単位で有効・無効が指定できる。
- 新旧のオブジェクトが両方保存され、バージョンIDで区別される。

### Webサイトホスティング機能

静的コンテンツに限って、Webサイトとしてホスティングする環境を作成できる。

RubyやPHPなどのサーバサイドな動的コンテンツに関しては、S3をWebサイトホスティングとして使用することはできない。

独自ドメインでS3 Webサイトホスティングする場合はRoute53などのDNSにCname情報を設定し、バケット名をドメイン名を一致させる必要がある。

### S3のアクセス管理

バケットポリシー、ACL、IAMが使用できる。

|  | バケットポリシー | ACL | IAM |
| --- | --- | --- | --- |
| AWSアカウント単位の制御 | ○ | ○ | X |
| IAMユーザ単位の制御 | ▲ | X | ○ |
| S3バケット単位の制御 | ○ | ○ | ○ |
| S3オブジェクト単位の制御 | ○ | ○ | ○ |
| IPアドレス・ドメイン単位制御 | ○ | X | ○ |

- バケットポリシー
    - バケット単位でアクセスを制御する。そのバケットに保存されるオブジェクト全て適用されるので、バケットの用途に応じて全体的なアクセス制限をするときに有効
    - バケット内の特定のパスにのみルールが適用できる。
- ACL（アクセスコントロールリスト）
    - オブジェクト単位で公開・非公開を制御するために使用する。
- IAM
    - ユーザ単位でS3のリソースを制御する場合に使用する

`注意点`

IAMユーザに対する制御はバケットポリシーでも可能だが、IAMポリシーを使った方がよい

### 署名付きURL

- アクセスを許可したいオブジェクトに対して、期限を指定してURLを発行する機能
- バケットやオブジェクトのアクセス権を変更せずに、特定のオブジェクトを一時的に許可する場合に有効。ただ、署名付きURLを知っているユーザーは期間中誰でもアクセスできてしまうので、注意が必要。

### データの暗号化

- サーバ側での暗号化
    - データがストレージに書き込まれるときに暗号化される。
- クライアント側での暗号化
    - AWS SDKを使って、S3に送信する前にデータが暗号化される。復号はクライアント側で暗号化されたデータのメタデータからどのキーで復号するか判定する。

### S3のブロックパブリックアクセス権

```yaml
意図しないでS3バケットを外部効公開による情報漏洩があるため、ブロックパブリックアクセス機能を使用する。
```

新規、任意のACLおよびバケットポリシーの４段階でパブリックアクセスを禁止する設定ができる。

新規のバケット作成はデフォルトでパブリックアクセスをブロックするようになっている。

### S3 Access Analyzer

```yaml
S3バケットの監視、保護ができる。
```

### S3のその他の機能

### S3 Select

SQL文を利用して、S3オブジェクトのコンテンツをフィルタリングし、必要なデータのみを取得することができる。データ転送量が制限できるので、コストと時間の短縮ができる。

### S3 Transfer Acceletation

遠隔地のS3へのデータ転送をサポートする機能

日本から海外のリージョンのS3に転送する場合、回線の十分な帯域と安定性がないと時間がかかる。Cloud Frontのエッジロケーションを活用して、大容量かつ安定sちあバックボーン回線を利用して転送することができる。

---

### S3 Glacier

```yaml
データを保存するとデータの取り出しに時間がかかる。
またS3のように保存するデータに対して、名称をつけることはできない為、
自動採番されたアーカイブIDで管理することになる
```

- ユースケース

長期間保存し、アクセス頻度が低く、取り出しに時間がかかっても問題ないデータを保存する場合

- 保存方法

S3 Glacierのデータ保存方法はAPIによる操作かS3のライフサイクル管理機能によって行える。

### S3 Glacierの構成要素

- ボールト
    - アーカイブを保存するための領域。S3のバケットに相当する。命名規則はリージョンおよびアカウント内で一意であればよい
- アーカイブ
    - データ自身。S3オブジェクトに相当。アーカイブIDは自動的に割り振られる
- インベントリ
    - それぞれのボールドに保存されているアーカイブの情報（サイズ、作成日、アップロード時に指定されたアーカイブの説明）収集。1日に１回の頻度で更新されるため、情報更新にはタイムラグがある。
- ジョブ
    - アーカイブやイベントリに対して検索をかけたり、データをダウンロードするなどの要求に対して処理を実行し、状況を管理する。
    

### データの取り出しオプション

取り出したたい場合はリクエストを出す。リクエストを出してから実際に取り出せるようになるまでの時間は、高速、標準、バルクの３種類にリクエストオプションがあり、待ち時間が短いほどリクエストにかかる費用が変わる。

### S3 Glacier select

保存したデータを参照するには対象アーカイブを読み出し、リクエストして待つ必要がある。

S3 Glacier select はアーカイブに対して、SQLを実行して、条件にあったデータを抽出する機能

### データの暗号化

データを保存するときにはSSLを使ってデータ転送が行われる。S3 Glacier select は標準で暗号化されるため、独自で暗号化したい場合はS3 Glacier select に保存する前に暗号化が必要

### 削除禁止機能（ボールトロック）

削除を阻止したい場合は

- S3 のバケットポリシーやIAM権限で実施できる人を制限する
- S3 Glacierの削除防止機能を利用して、削除できないようにする。
    - S3 Glacier APIを通じてボールトロックポリシーを対象となるボールトに要求する必要がある。
    - ボールトロックポリシーは５年経過するまで、ユーザは削除する権限を拒否するといった内容

---

### Storage Gateway

```yaml
オンプレにあるデータをクラウドへ連携するための受け口を提供するサービス
```

- Storage Gataway 連携されたデータの保存先は、S3やS3 Glacierといった耐久性が高く、低コストなストレージが利用される。
- あくまでもストレージではなく、S3などの連携してAWSとオンプレを連携するインターフェイス
- キャッシュストレージとして、EBSが使われる。
- オンプレとのハイブリッド環境で参照頻度の高いデータはオンプレの高速ストレージでに保存し、参照頻度が少ないものはS3などに保存する使い方ができる。
- VMware Hyper-Vの仮装アプライアンスとしてのイメージが提供されており、オンプレ側にハイパーバイザーがすでに存在していれば、簡単に連携できる。
- またIAMも用意されており、AWS上にゲートウェイを配置することもできる。

Storage Gatewayのタイプ

以下の３タイプが用意されている。

- ファイルゲートウェイ
    
    ```yaml
    S3をクライアントサーバからNFSマウントして、あたかもファイルシステムのように扱うことができる。
    ```
    
    1. 非同期だが、ほぼリアルタイムでS3にアップロードされる。
    2. S3のオブジェクトとして保管されるため、APIで呼び出すこともできる。
    3. ローカルよりも読み書きの速度は遅い
        1. 保管データをAPIで呼び出すようなユースケースであれば、有効
- ボリュームゲートウェイ
    
    ```yaml
    各ファイルをS3のデータ保存領域全体を１つのボリュームとして管理
    そのため、APIでファイルを呼び出すことはできない。
    
    スナップショットを取得できるため、スナップショットからEBSを作ることができる。
    ```
    
    - キャッシュ型ボリューム
        - 頻繁に利用するデータはStorage Gateway内のキャッシュディスクに保存して高速アクセスすることが可能、すべてのデータを保存するストレージとしてS3を利用するタイプのゲートウェイ
        - データ量が増えても、ローカルディスクを拡張する必要がなく、効率的に大容量データを管理することができる。
        - キャッシュにないデータはS3から取得するため、データの読み込み速度に問題がある。
        - キャッシュボリュームは頻繁に使用するデータに対して高速にアクセスするためのもので、アップロードバッファーボリュームはS3にアップロードするための一時データを保存する部分
    - 保管型ボリューム
        - すべてのデータを保存するストレージとして、ローカルストレージを使用して、定期的にスナップショット形式でS3へ転送するタイプのボリュームゲートウェイ
        - 必要に応じてスナップショットをEC2にアタッチすることで、アクセス速度は早い
- テープゲートウェイ

```yaml
テープデバイス代替として、S3やS3 Glacierにデータをバックアップするタイプのゲートウェイ。
```

### Storage Gatewayのセキュリティ

- CHAP認証
    - クライアントからStorage GatewayにiSCSIで接続する際にCHAP認証を設定することができる。CHAP認証を設定することで不正なクライアントからのなりすましを防止できる。
- データの暗号化
    - AWS KMSを使ってデータの暗号化が可能。暗号化されるタイムングはデータを保管されているときで、S3でも穂zんされるタイミングで暗号化される。また、暗号化されたボリューム取得したスナップショットも同じキーで暗号化される。
- 通信の暗号化
    - オンプレからHTTPSが使用されるため、通信時のデータ内容は暗号化される。

---

## RDS

### amazon RDS

```yaml
MySQL,mariaDB,PostgreSQL,Oracleなどオンプレでも使い慣れた
データベースエンジンから好きなものを選択できる。
```

メリット

- バックアップやハードウェアメンテナンスなどの運用作業
- 障害児に復旧作業はAWS側が提供するマネージドサービスが利用できる。

注意点

- 様々なDBに対応しているが、RDSでは使用できない機能もある。RDSを利用する場合は機能制限をよく確認する必要がある。
- アプリケーションの仕様上使えない機能が必要な場合は、EC2インスタンスにデータベースエンジンをインストールして使用する必要がある。

### RDSで使えるストレージサービス

　RDSのデータ保存用ストレージにはEBSを利用する。EBSの中でもRDSで利用可能なストレージタイプは「汎用SSD」「プロビジョンIOPS SSD」 マグネティックの３つ

### RDSの特徴

### マルチAZ構造

1つのリージョン内の２つのAZにDBインスタンスをそれぞれ配置し、障害発生時やメンテナンス時にダウンタイムを短くすることで高可用性を実現するサービス

DBインスタンス作成時にマルチAZ構造を選択することで、後はすべてAWSが自動でDBの冗長性に必要な環境を構築してくれる。

### デメリット

- ２つのAZ間でデータを同期するため、ジングルAZ構造よりも書き込みやコミットに時間がかかる。そのため、本番ではマルチ構造にして、環境テストを行う必要がある。
- ファエイルオーバーが発生した場合、RDSへの接続用FQDNのDNSレコードがスタンバイ側のIPアドレスに書き変わる。そのため、60−120秒程度時間を要する。

---

### リードレプリカ

```yaml
通常のRDSとは別に、参照専門のDBインスタンスを作成することができる。
```

メリット

- マスターDBの負荷を抑える
- 読み込みが多いアプリケーションにおいて、DBリソースのスケールアウトを用意に実現できる

注意点

- マスターとリードレプリカのデータ同期は、非同期レプリケーション方式。そのため、リードレプリカを参照するタイミングによっては、マスター側で更新された情報が反映されないこともある。

---

### バックアップ・リストア

- **自動バックアップ（DBスナップショット）**
    - バックアップウィンドウと保持期間を指定することで、1日１回自動的にバックアップを取得してくれる。
    - 保管期間は最大35日
    - バックアップからDBを復旧する場合は、取得したスナップショットを選択して、新規RDSを作成する。
    - 稼働中のRDSバックアップのデータを戻すことはできない。
- **手動スナップショット**
    - 任意のタイミングでRDBのバックアップを取得することができる
    - スナップショットは１リージョンあたり100個までとなっている
    - シングルAZ構成でスナップショットを取得する場合、短時間のI/O中断時間がある
- **データのリストア**
    - RDSにデータをリストアする場合は、自動バックアップ、および手動で取得したスナップショットから新規のRDSを作成する。
- **ポイントインタイムリカバリー**
    - 直近五分前〜35日前まで任意のタイミングでRDSを新規に作成することができるサービス
    - 戻すことができる最大日数は自動バックアップの取得期間に準ずる。
    - ポイントインタイムリカバリーを使用したい場合は、自動バックアップを有効にする必要がある。
    

### セキュリティー

- **ネットワークセキュリティ**
    - RDSじゃVPCに対応しているため、インターネットに接続できないAWSのVPCネットワーク内でも利用可能
    - DBインスタンス作成時にインターネットから接続する許可するオプションもある。（デフォルトはオフ）
    - セキュリティグループによる通信要件の制御も可能
- **データの暗号化**
    - RDSの暗号化オプションを有効にすることで、データが保存されるストレージやスナップショットだけでなく、ログなどのRDSに関連するすべてのデータが暗号化された状態で保持される。
    - すでにあるデータを暗号化したい場合はスナップショットの暗号化コピーを作成し、作成したスナップショットからDBインスタンスを作成することができる。

---

## Amazon Aurora

- 高い並列処理によりクエリを高速処理化することができる。
- 大量の書き込みと読み込みを同時に扱うことができる。
- DBインスタンスを作成すると同時にDBクラスタが作成される。
- DBクラスタは１つ以上のDBインスタンスと各インスタンスから参照するデータストレージ（クラスタボリューム）で構成
- NoSQL型の分散高速処理とRDBのデータ操作性をどちらも実現できている
- SSDをベースとしてデータストレージをクラスタボリューム
- クラスタボリュームは１つのリージョン内に３つのAZにそれぞれ2つ（計6つ）のデータコピーが構成され、各ストレージ間のデータは自動的に同期される。
- クラスタボリューム作成時に容量を指定する必要はなく、Aurora内に保存されるデータ量に応じて、最大64TBまで自動的に拡張される。

### Auroraレプリカ

- マルチAZ構造オプションはない。ただ参照専用のAuroraレプリカを作成することはできる。

### エンドポイント

通常のRDSを作成すると接続用エンドポイントが１つ作成され、そのエンドポイントを使ってDB接続をする。

Auroraは次の３種類のエンドポイントが作成される。

- クラスタエンドポイント
    - プライマリインスタンスに接続するためのエンドポイント
    - 参照、作成、削除、更新、定義変更）を受け付けることができる。
- 読み取りエンドポイント
    - レプリカインスタンスに接続するためのエンドポイント
    - 参照のみを受け付けることができる。
    - 複数のレプリカインスタンスがあれば、読み取りエンドポイントに接続することで自動的に分散負荷が行われる
- インスタンスエンドポイント
    - 各DBインスタンスに接続するためのエンドポイント
    - 特定のDBインスタンスに接続したい場合に使用する
    - 接続したDBインスタンスがプライマリインスタンスである場合は、すべての操作が可能
    - レプリカインスタンスである場合は参照のみ可能

---

## RedShift

データハウス向けのデータベースサービス

大量のデータから意思決定に役立つ情報を見つけ出すために必要な環境になっている。

### 構成

- Redshiftクラスタ
    - Redshiftを構成する複数のノードのまとまり
- リーダーノード
    - SQLクライアントやBIツールから実行クエリを受けて、クエリ解析や実行プランの作成を行う。司令塔的な役割。リードノードは各クラスタに１台のみ存在している。
- コンピュートノード
    - リーダノードから実行クエリを処理するノード。各コンピュートノードはストレージとセットになっている。コンピュートノードを追加することで、CPUやメモリ、ストレージといったリソース
- ノードスライス
    - 分散並列処理をする最小単位。コンピュートノードの中で、さらにリソースを分割している。ノード内のスライスの数は、コンピュートノードのインスタンスタイプによって異なる。

### Redshiftの特徴

- 列指向型データベース
- 多くの圧縮エンコード方法への対応
- データI/Oボトルネックを発生させないためにも、取得するデータ量を削除するアプローチもある。Redshiftは９種の圧縮エンコード方法に対応しており、列ごとに圧縮エンコードが可能なため、データの性質に合った圧縮ができる。
- ブロック単位でデータが格納される。１ブロックの容量は１MB。ゾーンマップとはそのブロック内に格納されているデータの最小値と最大値をメモリに保存する仕組み。保存することで、データ検索条件に該当する値の有無などを効率的に判断でき、データが存在しない場合はそのブロックを読み飛ばして処理を高速化できる。
- **MPP**
    - １回の集計処理を複数のノードに分散して実行する仕組み。この仕組みがあることで、ノードの追加をするだけで分散処理の速度が向上する。
- **シェアードナッシング**
    - 各ノードがディスクと共有せず、ノードとディクスセットで拡張する。複数のノードが同一ディスクを共有することによる性能劣化を回避する。
    - 

---

## DynamoDB

```yaml
NoSQLデータベースサービス
テーブルやインデックスを作成する際に読み取り、必要なスループットを指定してリソースを確保することで、
安定した性能を担保する仕組み

拡張性に優れており、Key-Value型でデータベースを提供する。
```

`メリット`

- 高い信頼性と拡張性を必要とするシステム
- スループットが増減するようなピーク帯のあるシステム
- 大量のデータを蓄積して高速な検索が可能
- 広告やゲームなどのユーザー行動経歴を管理するシステム

特徴

### 高可用性設計

単一障害を持たない構成のため、サービス面での障害やメンテナンスを考える必要はない

### スループットキャパシティ

インデックスを作成する際に読み取りと書き込みに必要な計算量を指定する。ダウンタイムなく変更できるため、スループットキャパシティは読み取り専用と書き込み専用それぞれ個別に。キャパシティユニットを指定する。

- Read Capacity Unit（RCU)
    - 読み取りのスループットキャパシティを指定する指標。一秒あたり１回の強力な整合性のある読み取り性能、あるいは一秒あたり２回の結果的に整合背いのある読み取り性能を担保する
- Write Capacity Unit
    - ：書き込みのスループットキャパシティを指定する指標。

負荷に応じて、スループットキャパシティは自動スケーリングしてくれる。なお、急激なスループットの上昇に即座に対応できるわけではないため、事前に急激なデータ量が増えることがわかった場合は、手動でキャパシティの拡張をする必要がある。

### データパーティショニング

データをパーティションという単位で分散保存する。データの増加や指定したスループットのサイズによって自動的に最適化される。

### プライマリーキーとインデックス

```yaml
DynamoDBはKey-Value型のデータベースであるため、
格納されるデータ項目はキーとなる属性とその他の情報によって構成される
```

- プライマリキー
    - データ項目を一意に特定する属性するための属性で、パーティションキー単独のものと、パーティションキー＋ソートキーの組み合わせで構成されるものの２種類がある。
    - パーティションキーだけでは特定することができない場合に、ソートキーを組み合わせてプライマリキーを構成する。
    - プライマリキーはインデックスとしても利用され、データ検索の高速化に役立つ
    - プライマリキーだけでは高速な検索要件を満たすことができない場合は、セカンダリーインデックスを作成することで高速な検索が可能となる。
- セカンダリーキー
    - ローカルセカンダリーインデックス（LSI）
        - プライマリキーはテーブルで指定したパーティションキーと同じで、別の属性をソートキーとして作成するインデックスのことを指す。
        - LSIは複合キーテーブルにのみ作成することができる。
    - グローバルセカンダリーインデックス（GSI)
        - プライマリーキーとは異なる属性を使ってインデックスのことを示す。

＊セカンダリーインデックスは便利だが、Key-Value型のデータベースの使い方の本質ではない、。作成した分だけデータ容量を確保する必要があったり、別のキャパシティユニットが必要であったりとコストの追加も必要になる。

### 期限切れデータの自動メンテナンス

DynamoDB内の各項目には有効期間が設定でき、有効期間を過ぎたデータは自動的に削除される。自動メンテによるデータ削除操作はスループットキャパシティユニットを消費しないため、この機能を有効化することで、過去のデータメンテナンスを効率的に実施できる。

### DynamoDB Streams

直近行われた２４時間の追加更新削除の変更履歴を保持する機能。

DynamoDBを使ったアプリケーションの利用履歴を把握できることはもちろん、データが変更されたタイミングを検知できる、変更内容に応じた処理をリアルタイムで実行する仕組み

### 強い一貫性

結果整合性のデータモデルを採用したデータベース。

オプションを有効化すると参照リクエストがあった時点よりも前に書き込まれたデータがすべて反映された状態のデータを元に参照結果を返すようになる。RCUは２倍消費される点に注意が必要。

### DynamoDB Accelerotor（DAX)

DynamoDBの前にキャッシュクラスタを構成する拡張サービス

DAXを使用することで、毎秒数百万もの読み取り処理が高速で可能となる。

RCUの確保を抑えられるため、コスト削減にも大きく貢献する。

---

### ElastiCache（エラスティキャッシュ）

```yaml
インメモリ型データベースサービス
高頻度で参照するデータや検索に時間がかかるデータセットをメモリ上に保持することで
システムパフォーマンス向上に繋がる。
```

- Memcached
    - KVS（Key-Valueストア）型インメモリデータベースのデフォルトスタンダードとして広く利用されているエンジン。
    - シンプルな構造で、データ処理パフォーマンスの向上や特化したキャッシュシステム。
    - データの永続性はないため、メンテナンスや障害による再起動が行われた場合、データ消える。
    - 最大20このインスタンスで構成されている。
    - クラスタ内に保存されているデータは各インスタンス分散されている。
    - 可用性を考慮して複数のAZにインスタンスを作成するようにする。
        
        
        | エンドポイントの種類 | 利用用途 |
        | --- | --- |
        | ノードエンドポイント | クラスタ内の各ノードに個別にアクセスするためのエンドポイント。特定のノードにのみ必ずアクセスした場合に使用する |
        | 設定エンドポイント | クラスタ全体に割り当てられるエンドポイント。クラスタ内のノード増減を管理し、クラスタ構成情報を自動で更新する。アプリケーションからElastiCache |
        - スケーリング
            - スケールアウト、スケールイン
                - ノードを増減させた場合、正しいノードにデータが再マッピングされるまでの間、キャッシュミスが一時的に増加することがある。
            - スケールアップとスケールダウン
                - 新規のクラスタを作成する必要がある。Memcachedにはデータ永続性がないため、クラスタを再作成した場合、それまで保持していたデータはすべて削除される。
    
    　ユーズケース
    
    ```yaml
    　- シンプルなキャッシュシステムを利用したい。
    　- データが消えてもシステムの動作に大きな影響を与えない
    　- 必要なキャッシュリソースの増減が頻繁で、スケールアウト・スケールインをする必要がある。
    ```
    
- Redis
    - KVS型のメモリデータベースだが、Memcachedよりも扱えるデータ型が多い
    - ノード間のレプリケーション機能やデータ永続機能といった可用性面も考慮された機能が実装されている
    - クラスタモードの有効・無効に応じて冗長化の構成が変わる。
    - どちらもマルチAZ構成を作成することができる。
    - マスターインスタンスが障害状態になった場合、スタンバイインスタンスがマスターインスタンスに昇格する。
    - クラスタモード無効
        - キャッシュデータはすべて１つのElastiCacheインスタンスに保存される。また、同じデータを持つリードレプリカは最大5つまで作成することができる。
        - １つのマスターインスタンスとリードレレプリカのまとまりをシャドーと呼ぶ
    - クラスタモード有効
        - クラスタモードが有効の場合、最大500のシャドーにデータを分割することができできる。リードレレプリカは１つのシャドーに対して、最大５つまで作成できる。
        - データ分散をすることで、Read/Writeの負荷分散構成を作成することができる。
    
    　ユーズケース
    
    ```yaml
    - 文字列、リスト、セット、などの多様なデータ型を使いたい
    - キーストアに永続性を持たせたい
    - 障害発生時に自動的にフェイルオーバーしたり、バックアップ・リストアなどの可用性がほしい
    ```
    

### CPU使用率

Redisはシングルスレットなので、１コアで動作する。たとえば４コアのインスタンスタイプを使用しても１コアしか使われないので、CPU利用率は25％が最大。

### データの暗号化

Redisは暗号化に対応しているが、Memcachedは暗号化に対応していない。

その他のDB

| サービス名 | 説明 |
| --- | --- |
| Amazon Neptune | フルマネージドのグラフデータベース。ノード、エッジ、プロパティの３つの要素で構成されており、ソーシャルグラフのようなつながりの関係を表現するのに適している |
| Amazon DocumentDB | フルマネージドなMongoDB互換のドキュメントDB。サーバ上で独自に構築したMongoDBを移行することもできる。 |
| Amazon Keyspace | Appche Cassandra互換のデータベースサービス
サービスとしての特徴はDocumentDB同様だが、Cassandraは列指向データと行指向データの両方の特徴を兼ね備えているので、検索性も高く任意のデータをまとめてとってくることも得意としている。 |
| Amazon Time stream | 時系列データベース。時系列データを扱うことに特化したデータベース。RDBよりも数千倍の速度でかつ低コストに処理、分析できるように設計されているIotやサーバーモニタリング用途に最適 |
| Amazon QLDB | 台帳データベース。変更履歴などを全て残し、履歴を検証可能な状態にするもの。
ブロックチェーンフレームワークが活用される |
|  |  |
|  |  |

---

# セキュリティとアイデンティティ

### AWSのカウントの種類

- AWSアカウント
    - AWSへサインアップするときに作成されるアカウント。このアカウントはAWSの全てのサービスをネットワーク上のどこからでも利用可能、そのユーザーはルートユーザとも呼ばれる。
- AWS Organizations（組織アカウント）
    - 組織アカウントを利用することで複数のアカウントの請求を一まとめにする一括決済が可能。
    - 利用可能なサービスをAWSアカウント単位で制限するサービスコントロールポリシーも利用できる。
- AWSアカウント（ルートユーザ）
    - AWSの全サービスに対してネットワーク上のどこからでも操作できる権限をもっている。
    - ルートユーザにIPアドレス制限をする方法がないため、多要素認証（MFA）の設定などをする必要がある。
    

### **IAMユーザー**

```yaml
AWSの各利用者がWebコンソールにログインして操作するときや、APIを利用してAWSを操作する時などに使用する。書くIAMユーザーに対して、操作を許可するサービスを定義することができる。
```

- IAMユーザの認証方法
    - ユーザIDとPASS…Webコンソールにログインするときに使用する。
- アクセスキーとシークレットアクセスキー
    - CLIやAPIのリソースにアクセスする場合に使用する。
    

### IAMロール

```yaml
一時的にAWSリソースへのアクセス権限を付与する。
```

- AWSリソースへの権限付与
    - EC２インスタンス上で稼働するアプリケーションに一時的にAWSリソースへのアクセス権限を与える
- クロスアカウントアクセス
    - 複数のAWSアカウント間のリソースを１つのIAMユーザで操作する
- IDフェデレーション
    - 社内サーバーに登録されているアカウントで、AWSリソースにアクセス
- Web IDフェデレーション
    - FecebookやGoogleアカウントを使用して、AWSリソースにアクセス

### IAMグループ

同じ権限を持ったユーザの集まり、グループはAWSへのアクセス認証情報は保持しない。認証はあくまでも個人に行い、グループは同じ認証をもった集まりを管理するためにすぎない。

１つのグループに複数のユ

ーザを属することは可能

1人が複数のグループに属することも可能

グループが他のグループに属することはNG

- IAMポリシーの流れ
    - AWSサービスやAWSリソースに対する操作権限
    - このポリシーをIAMユーザーやIAMグループにアタッチする
    - IAMユーザーまたはIAMグループはコンソールにログインすると、付与された権限の操作を行うことができる。
- IAMポリシー
    - Action（どのサービスの）
    - Resource（どういう機能や範囲）
    - Effect（許可・拒否）
    
    この３つの大きなルールに基づいて、AWSの各サービスを利用する上で様々な権限を設定する。
    
    このポリシーをIAMユーザ、グループ、IAMロールに付与することで権限を制御する。
    

### インラインポリシーと管理（マネージド）ポリシー

ポリシーには２つの管理ポリシーがある

- インラインポリシー
    - 対象ごとに作成・付与するポリシーで、’複数のユーザ・グループに権限を付与するには向いていない
- 管理ポリシー
    - １つのポリシーを複数のユーザやグループに適用できる。
    - **AWS管理ポリシー**
        - AWS側が用意しているポリシーで、管理者権限やPowerUser、あるいはサービスごとのポリシーなどがある。
    - **カスタマー管理ポリシー**
        - ユーザ自身が管理するポリシーで、記述方法自体はインラインポリシーと同じだが、ポリシーを共有できる点がことなる。
        - 変更した権限に誤りがった場合、即座に前にバージョンに権限に戻すことが可能
    
    ### 使い分け
    
    ```yaml
    AWS管理ポリシーで基本的な権限を付与し、
    カスタマーポリシーでIPアドレス権限などの制約を行う。
    
    インラインポリシーは使わないが、一時的に個別のユーザに権限を付与するときに利用する
    ```
    ルートユーザ

```yaml
クレジットカード登録して作成したアカウント
```

- フル権限
- 請求情報閲覧可能
- パスワード変更可能
- 日々の業務では使用しない

IAMユーザー

```yaml
AWSアカウントの間で使える日々の業務で使えるアカウント
```

IAMユーザー作成時

アクセスキーでの認証

シークレットキーとアクセスIDが発行される（どちらもランダム）

この情報があるとどこからでも入れるので注意が必要

パスワード認証もある。

IAMグループ

- 複数のIAMユーザーのまとまり
- ユーザーは個人だけでなく、プログラムが利用する場合もある
- IAMユーザーはそれぞれ認証情報を持っている。
- 認証情報にはパスワードかアクセスキー、もしくは両方を持つケースがある。

IAM policy

AWSで操作できる権限を表したもの、JSON形式で記述された設定ファイル

認証主体にアタッチして使用することができる。

---

### KMSとCloudHSM

AWS key Managemetnt Service(KES)やAWS Cloud HSM

```yaml
暗号化の作成と管理のためのサービス
```

Cloud HSMはVPC内で専有のハードウェアを利用して鍵を管理するサービス

KESはAWSが鍵を管理するマネジメントとサービス

|  | CloudHSM | KMS |
| --- | --- | --- |
| 専有性 | VPC内の専有ハードウェアデバイス | AWSが管理するマルチテナント |
| 可用性 | ユーザ側が管理 | AWS側が管理し、高い可用性がある。 |
| 信頼の基点 | ユーザ側が管理 | AWS側が管理 |
| 暗号化機能 | 共通鍵および公開鍵 | 共通鍵 |
| コスト | ほぼ固定費 | 従量課金性 |

### Cloud HSM

専有のハードウェアを使用するため、初期コストも月次の固定費用も必要。よほど大規模なシステムや特定の規制対応のため以外は利用することは少ない。

### KMS

主な機能は鍵管理機能とデータ暗号化機能。

データ暗号化機能とは

- Encrypt
    - 文字通りデータを暗号化するためのAPI。4KBまでの平文データに対応している
- Decrypt
    - 復号のためのAPI
- GenerateDataKey
    - ユーザがデータの暗号化を利用するための、カスタマーデータキーを生成。
    - Customer Master Key(CMK)
        - データキーを暗号化するための鍵
    - Customer Data Key(CDK)
        - データを復号化するための鍵。
    
    CMKがCDKを暗号化し、データをCDKが暗号化する。（エンベロープ暗号化によって、全体的なセキリュティーが高まる。
    

---

### 暗号化を行う場所

- クライアントサイド暗号化
    - ユーザ側の処理で暗号化する方法。
    - 多くの場合はSDKを利用して行う
    - 該当するのはS3などの１部サービスのみ
- サーバーサイド暗号化
    - AWSサービスが暗号化対応である場合は、基本的にサーバーサイド暗号化を使用されることになる。

---

### AWS Ceritificate Manager

サーバとのやり取りの暗号化、またそのサーバーの信頼性を確認するため、サーバー証明書が利用されている。

証明書を利用して実現できること

- 経路間の通信の安全性確保
- 通信している相手が誰なのかの証明
    - 信頼性の高い第３者が必要となるため、認証局（CA)という証明書を管理する機関によって発行される。
- 自己証明書
    - 自分で認証局を立てて、証明書を発行する。
- ドメイン証明
    - ドメイン所有のみを認証。組織認証の確認はされない
- 組織認証
    - 組織情報の審査を得てから認証する。
- 拡張認証
    - 組織認証よりも厳格な審査で認証する。アドレスバーに組織名が表示する。

### ACM

- AWS自身が認証局となってDV証明書を発行するサービス
- ACMの証明書有効期限は13ヶ月
- 自動で更新するように設定することができる。
- ACMを利用できるのはAWSサービスのみだが、費用は無料
- ACM初期設定には、ドメインの所有確認が必要。ドメインの所有証明にはメール送信、もしくはDNSを利用。

連携可能なサービス

- ELB
- Amazon CloudFront
- AWS Elastic Beanstalk
- AWS API Gateway

### まとめ

```yaml
ACMはAWS自身が認証局となり、RSA鍵とサーバー証明書の作成や管理を行うサービス
```

---

## AWSアプリケーションサービス

### Amazon Simple Queue Service（SQS）

```yaml
タスクのトリガーとなるキューを複数管理することで、ワークロードの並列実行を実現する
AWSの様々なサービスと連携して通知可能で、疎結合アーキテクチャを実現する。
```

基本的な機能

- 単一発行メッセージをキューとして利用（メッセージを送ったらキューに貯まる）
- ポーリング処理型のキューイングサービス（キューを受け取る側が受け取れる状態になったら、受け取ることができる）
- 標準キューはメッセージ通信順序は保証されないが、FIFOキューは順番を保証する
- 優先キューは他のキューよりも優先的に処理されることが可能
- メッセージ保管期間の間はメッセージを保管するが、超過するとメッセージは削除する
- 発行したメッセージは取り消し不可
- 配信ポリシーによるキューの再試行を実施する

ポーリングとは

```yaml
producer(送信処理）が送信したメッセージをキューに格納しておき、受信側がタイミングがいいときに通信を行うこと
SQSにメッセージの有無を問い合わせる
```

ロングポーリング

- メッセージがない場合は設定されたタイムアウトのギリギリまでレスポンスを返さない

ショートポーリング

- リクエストを受け取るとメッセージの有無に関わらず、レスポンスを返す
- デフォルトの設定となっている。

無制限にメッセージを利用可能だが、メッセージ保管期間をうまく設定しておくことが必要

**メッセージに制約**

- メッセージ数は無制限に利用可能
- メッセージサイズは最大256KB
- コンシューマー側では一度に10件までメッセージ受信可能

**メッセージの保管期間**

- デフォルトは4日（Min60秒~Max14日）
- アプリケーション側でメッセージ削除を実施しないと、保管期間中はメッセージが滞留してしまう。

### SQSのキュータイプ

- **標準キュー**
    - メッセージの１つ以上のコピーが順序通りに配信できないことがある
    - メッセージは少なくとも１回配信される方式、キューには重複が発生する可能性がある
    - 一秒あたりのトランザクション数は無制限
    - 標準キューはアプリケーションが１回以上に順序が正確でなくても配信されればOKなケースで使われる。
    - 細かい制御をすることができない。
    
- **FIFOキュー**
    - 先入先出（FIFO）により配信に順番を守る
    - メッセージが１回だけ配信され、コンシューマがプロセスを処理して削除するまで使用可能なキューの状態を保持するため、重複はない
    - 一秒あたりのトランザクションは300まで
    - FIFOキューは、操作やイベントなど順序が大切な場合や重複がNGな場合のユースケースに使用できる。

### **SQSの識別子**

- キューURL
    - キューに割り当てられるURL
- メッセージID
    - メッセージに対して割り当てられたID
- メッセージグループID
    - 特定もメッセージグループに属するメッセージを指定するタグ
    - 同じメッセージグループに属するメッセージはメッセージグループに対照的な厳密な順序で１つずつ処理される
    - 単一のFIFOキュー内で複数の順序付きメッセージグループをインターリーブする。メッセージIDを使用する。
    

FIFOキュー＋メッセージグループIDにすることで同じグループで順序別に取り出すことができる

![スクリーンショット 2022-06-30 19.01.41.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b7754d20-197b-4fe0-a431-6b8c15668339/スクリーンショット_2022-06-30_19.01.41.png)

SQSの機能としては、キューの管理とメッセージ管理の２つが存在している。

キューとは、メッセージ管理をするための入れ物のようなもの

基本的には利用開始時に作成すれば管理する必要はなく、エンドポイントと呼ばれるURLを使用して、利用する形になる。

メッセージ管理機能としては、キューに対するメッセージの送信・取得と処理済みのメッセージの削除がある。

それ以外にも複数のキューをまとめて処理するバッチ用APIや処理中に他のプロセスから取得できなくする可視性制御APIもある

---

## AWSのワークフローサービス

### Amazon Simple Wrokflow(SWF)

- Step Functionsでカバーできなかったワークフローを行う。

### Step Functions

- ワークフローを可視化できる。
- 分散処理や並列処理が可能
- 処理順序も保証されている。

---

## SNSとSES

### SNS

複数のユーザにシステムの状態を知らせる際に使用するのがSNS（Amazon Simple Notification Service)

- プッシュ型の通知サービス。マルチプロトコルなので複数に配信ができる。
- メッセージをプロトコルごとに変換する部分はSNSが行う、通知する人はプロトコルの違いを意識することなく配信できる。
- SQSやCloudWacthなどと組み合わせて、システム間の連携や外部への通知などに利用する。

### 利用について

- トピックという単位で情報を管理する。
- Publisher（通知する人）・Subscriber(通知される人）
- Subscriberは利用するトピックを受け取るプロトコルを登録する
- Publisherはトピックに対してメッセージを配信するだけで、設定する必要ない
- SNSはメールやモバイルプッシュで人間に通知することも可能、SNSからLambdaを呼び出してプログラムに対処させることも可能。
- 各サービスの疎結合化を実現できるため、自由度が高く、全体のテストなどが必要ない。

### SES

- E-mail送信サービス。SMTPプロトコルまたはプログラムを利用して直接E-mailを送信する際に使用する。
- E-mailを受信し、S3に保存することも可能
- 送信時にウイルスやマルチウェアを検出してブロックする機能
- 拒否や苦情などを統計的に自動的に処理し、配信不能などにを管理できる。
- SESは信頼性を保つために利用者にもいくつかの制約を課している。
    - 登録済みのメールアドレス。ドメインからのみ送信可能
    - Bounce Mail（配信不能メール）の比率5％以下に保ち続ける
    - 苦情を防ぐ
    - 悪意のあるコンテンツを送らない
    

---

### CodeCommit

```yaml
ソースコード管理のためのGitリポジトリサービスを提供するマネージドサービス
```

メリット

- IAMユーザを使用して権限管理を行うことができる。
- 他のサービスでGItリポジトリを運用する際にシームレスに連携できる。
- Gitリポジトリで何らかのイベントが発生した際に、それをトリガーにSNSトピックを呼び出すことができる。
- AWS側が提供するリソースにSSH接続することはできない。接続する場合はECインスタンス上にGitサービスを導入する必要がある。

---

### CodeBulid

```yaml
ソースコードをコンパイル・ビルド環境を提供するマネージドサービス
断続的な開発プロセスでは、最新ソースコードをビルドし実行できる形にするまでに流れを自動化することが多い。
```

- ビルド環境を簡単に構築可能
- ユニットテストを実行することもでき、継続的な品質の担保になる
- Java,PHPなどを標準的にサポートしている。個人で用意したDockerイメージも利用することができる。
- ビルド対象のソースコード取得元として、CodeCommitやgithubなどを利用することもできる。
- 対象外のソースコード元の場合はS3に転送する必要がある

ビルドの定義

- 設定ファイルはbulidspec.ymlに定義する
    - ビルドの環境セットアップ情報
    - ビルド・ユニットテストの実行コマンド
    - ビルド前後に実行したい処理
    - ビルド後の出力情報

料金体系

従量課金制度

負荷が高まってきたタイミングで環境スペックを高めることもできる。

---

### Code Deploy

```yaml
ビルド済みのモジュールのサーバーを自動的にデプロイするサービス。
```

一気にすべてのサーバーにデプロイするのではなく、少しずつデプロイすることができる。

### デプロイ先に選択可能

Code DeployはEC2やLambda、それぞれサーバーに対してモジュールをデプロイできる。

ただ、EC 2やオンプレの場合はCode Deployエージェントをインストールしておく必要がある。

デプロイ時にどのモジュールをどこに配置するかなどの設定はappspec.ymlに定義する。

オンプレサーバーへのデプロイも可能

### デプロイ方式の選択が可能

| デプロイ方式 | 具体的な動き |
| --- | --- |
| AllAtOnce | 関連するサーバー全てを同時にデプロイする。リリース時間は短いが、タウンタイムが発生する |
| HalfAtTime | 関連するサーバー群の半分をリソースに対してデプロイする。半分のリソースでも高負荷にならないように注意する。 |
| OneAtTime | 関連するサーバーを１つづつロードバランサーから切り離し、デプロイを行う。リリースに時間はかかるが、他のサーバへの負荷は少ない。 |
|  |  |

### デプロイ対象のサーバが増減する場合

デプロイの仕組みを自前で構築した場合は、サーバー数が増減した際に対処が必要

CodeDeployの場合はAuto Scalingグループをデプロイ対象にできるため、変動にも対処できる。

---

### CodePipeline

```yaml
ソースコードの管理、ビルド、サーバへのデプロイなど一連の作業を自動化するサービス
```

### 特徴

1. ソースコードをプッシュ
2. プッシュした内容を検出して、ソースコードをビルド
3. ビルドが完成したことを検知して、デプロイを行う

上記のようなパイプラインを行うことができる。

一部AWS以外のサービスを置き換えることも可能。

承認プロセスを定義することも可能

リリースの承認プロセスを途中で挟むことができる。承認者が承認するまでパイプラインの処理を止めることができる。

---

## AWS インフラ環境を自動構築化（プロビジョニングサービス）

### AWS Elastic Beanstalk(Elastic Beanstalk)

```yaml
インフラ自動構築サービス。インフラに詳しいメンバーがいなくても、適切な定番環境が構築できる。
```

Elastic Beanstalk CLIは複数のElastic BeanstalkのAPIを束ねたコマンドを提供している。

Elastic Beanstalkの定番構成

- Webサーバー（ELB+Auto Scaling+EC2)
- Batchワーカ構成（SQS＋Auto Scaling+EC2)

---

### OpsWorks

Chefを利用した構成管理サービス。レシピと呼ばれるファイルサーバーの構成を定義し、ミドルウェアのインストールや設定を自動化するツール

コードでインフラ環境を構築するテレフォームみたいなもん

### 利用方法

- Chef Client ローカル方式
    - 各サーバーがレシピを持ち、自分自身にレシピを適用する

Ops Worksスタック

```yaml
Chef Client ローカル方式でChefを利用する場合は、Ops worksスタックを利用します。
```

- スタック
    - OpsWorksのトップエンティティ。スタック単位の構成情報をJSON形式で保持する。
- レイヤー
    - インスタンスの特性ごとにレイヤーを用意する。レイヤーに対してChefレシピをマッピングする。レイヤーの指定してEC2インスタンスを起動することでインスタンスに対して、レシピが適用される。
    
    `注意点`
    
    - スタックをコピーすることもできる。東京リージョンで環境を作り、そのDR環境を別のリージョンにコピーすることも可能
    - レイヤー内で起動したEC2インスタンスには、Ops Worksエージェントがインストールされる。
    - このOps WorksエージェントがOps Worksへの通信経路が必要なので注意が必要。

---

- Chef Server/Client ローカル方式
    - マスターサーバを用意して、レシピそのものや各サーバーへのレシピ適用状況を管理する方式
    
    ### OpsWorks for Chef Automate
    
    Chefを統合的に利用する機能
    
    レシピが適用される各インスタンスをクライアントと呼び、それらとは別にクライアントを管理するマスターサーバが存在するアーキテクチャ
    
    - Cher Automateサーバが自動構築され、利用者側でChef Automateサーバー自体のバックアップを行う機能なども標準提供されている。
    - OpsWork for Chef Automateを利用する場合、マスターサーバーのセットアップはAWS側で行ってくれる。ElastiCa
    - Auto Scalingにも対応しており、クライアントノードを自動的に増やすことも可能
    - ダッシュボード上でも管理対象のノードやレシピを確認できる。
    
    ---
    
    ### Cloud Formation
    
    ```yaml
    AWSリソースを自動構築するためのサービス
    構築されたAWSリソースはスタックと呼ばれ、スタックはテンプレートと呼ばれる設計図に基づいてい生成される。
    
    ```
    
    流れ
    
    1. CloudFormationテンプレートを作成する。
    2. テンプレートを適用する。
    3. CloudFormationスタックが作成され、それに紐づく形でAWSリソースが自動構築される。
    
    CloudFormationスタック
    
    CloudFormationで構築されたAWSリソースはCloudFormationスタックという集合体にまとめられる。
    
    テンプレートを修正し、スタックを指定して再度適用することでAWSのリソース内容を変更できたり、リソースを削除雨することもできる。
    
    同じテンプレートを使うことで別のリージョンで同一のシステム構築が可能
    
    同一システム内でテンプレートを分割することで、複数のスタックにリソースを分けることもできる。
    

### CloudFormationテンプレート

テンプレートはJSON形式かYAML形式で記述する。

記述方法はいくつかのセクションに分かれている。

### Resourcesセクション

```yaml
Resources:
　cfnVpc:
	 type: 'AWS::EC2::VPC'
	 propertiers:
    cidrBlock: '192.168.0.0/16'
    Tags:
     - key: 'Name'
       Value: 'cfn-vpc'
```

構成するリソースの設計図を記載する。

各リソースには論理IDをつける必要があり、このテンプレートではcfn-vpcが論理IDとしてリソースの紐付けを行う。

リソースの型をTypeで定義する。

このテンプレートではAWS::EC2::VPCになる。

なおVPCリソースの場合はIPアドレンスレンジ（CidrBlock）の定義が必至。そのため192.168.0.0/16'を定義している。

### Parametersセクション

```yaml
Parameters:
 InstanceType:
  Type: String
  Default: t2.micro
  AllowedValues:
   - t2.micro
   - t2.small 
   - t2.medium
  Description: Select EC2 instance type.
```

実行時に値を選択する項目を定義するセクション。

インスタンスタイプを変数として定義し、実行時に選択する形にしている

Ref関数を使用して、インスタンスタイプやEC2キーペアなどの、環境によって変わる値をパラーメータ化することで、環境が変わるたびに書き換える必要がない汎用的なテンプレートにできる。

### Mappingsセクション

```yaml
Mappings:
 RegionMap:
  us-east-1:
   hvm: 'ami-a45dada'
  ap-northeast-1:
   hvm: 'ami-3gdadad'
```

変数をMap形式で定義できる。実行環境によって変化する値を定義する場合に使うことが多い。EC2インスタンスのAMI IDのようなもの。

```yaml
cfnEC2Instance:
 Type: 'AWS::EC2::Instance'
 properties:
  ImageId: !FindInMap[RegionMap, !Ref `AWS::Region`, hvm]
```

なお、FindInMap関数を使用することで、リージョンが変わってもテンプレートを書き換えなくてOKになる。

AWS ::Region は擬似パラメーター呼ばれるパラーメータで、Cloud Formaitonの実行リージョンを取得することができる。他にもAWS::AccountIdなどもある。

---

## EMR

```yaml
分散処理フレームワーク。
分散処理基盤と分散処理アプリケーション基盤の２つから構成される。
```

EMRの構成

- マスターノード
    - ジョブの振り分け
    - 1台のみ存在するため、フェールオーバができない
    - 異常があった場合は全てのタスクが失敗する
- コアノード
    - ジョブの実行
    - HDFS（Hadoop Distribuend File System)を持っている。
        - HDFS = なるべくデータを保存しているノードでそのデータの処理を行うことができる
- タスクノード
    - ジョブの実行
    - HDFS（Hadoop Distribuend File System)を持っていない。
    - タスクノードはコアノードよりも柔軟に増減ができる。

### 分散処理基盤としてのEMR

```yaml
分散処理に必要なEC2の調達、廃棄などを行うリソース機能
S3を分散処理扱いにしやすいストレージとして扱う（EMRFS）

が存在する。
```

- リソース調整機能
    - 伸縮自在性
        - 処理するEC2を解析開始時に調達、必要に応じて増減
        - デフォ設定の動作は、解析が完了するまで自動的にリソースを解放されるようになっている。
    - コスト面
        - 分散処理の動作の特定上スポットインスタンスとの相性がよく、EMRにもスポットインスタンスのオプションがある。
    
- ジョブの分割
    - 全体の処理を小さな単位のジョブとして分割する。
    - 分割したジョブを分散処理基盤内でインスタンスに振り分ける。
    - 振り分けたジョブが何らかの利用で動かない場合は、別のインスタンスに振り分け、ジョブを実行する。
- サポートアプリケーション
    - 分散処理を行うためには処理アプリケーションが必要。
    - 事前に用意されており、Spark HBase Prestoが有名どころ。

---

## ETLツール

### Kinesis

```yaml
ストリーミング処理プラットホーム
```

- Data Streams
    - センサーログなどをリアルタイムで処理する
    - データレコードの分散
        - どのストリームで処理されるかは、データ入力時に指定されたパーティションキーで決定される
    - 取得したデータを特定の場所に転送、保存することはできない
        - 指定した場所に保存するためには、Lambdaでポーリングして所定の場所に転送する。
- Data Firehose
    - 準リアルタイムで処理する
- Video Streams
    - 動画を処理する
- Data Analytics
    - 収集したデータの可視化、分析をする

### Data Pipeline

```yaml
データ処理やデータ移動を支援するサービス。
オンプレやAWS上の特定の場所に定期的にアクセスし、費用に応じてデータ変換し、S3やRDSなどのAWSの各種サービスに転送する。
```

- ビジュアルなドラックアンドドロップで操作できる。
- スケジュール実行以外にもエラー時の再実行や障害体制などが優れている。

### Glue

```yaml
データレイクやDWHとセットで使われるサーバレス型のETLツール
ビックデータの解析などに使われることが多い
```

- データ管理機能
    - データソースのデータを探索するクローラー機能
    - メタデータを管理するデータカタログ機能
    
    - クローラーが定期的にデータを探索し、データカタログでHiveメタストアの互換形式で保存
    
    変換処理はPythonやSparkによって実施されることが多い。
    

## その他の分析サービス

Amazon Athena

```yaml
S3内のデータを直接、分析できるようにする対話型のクエリサービス
```

- 所定の形式でS3のデータに対して、標準SQLでデータの操作ができる。
- CSV,ORC,Avro,Parquetのデータ形式に対応している。
- BIツールとの連携も可能
- 自前でインフラ構築する必要がなく、クエリから簡単に結果を取り出すことができる。

### Amazon QuickSight

```yaml
データの可視化ツール
```

- 簡単にダッシュボードを作成することができる
- 作成したダッシュボードはブラウザ経由で様々なサービスに埋め込むことが可能

# AWSにおけるアーキテクチャ設計

## 回復性の高いアーキテクチャ（信頼性）

- サービスの障害から復旧、負荷に応じた自動的なリソースの調整
- インスタンスやネットワークに生じた障害の軽減を考慮したシステム

### 回復性の高いアーキテクチャの構成要素

- 復旧手順のテスト
    - オンプレはネットワーク機器や分散機器のリソースはシステム間で共有で使われている。
    - クラウドの場合は、これらの設備を仮想的に占有することができる。
    - そのため復旧手順のテストも簡単になる
- 障害からの自動復旧
    - 主要なリソースの状況をメトリクスとして追跡することが可能
    - 閾値を設けて、負荷状況などが超過した場合にトリガーを設定することも可能
    - リソースの追加や問題のリソースの排除が可能
        
        ### 閾値の検出
        
        - 閾値の検出はCloudWatchを利用する。
        - インスタンス単体の障害はCloudWatchのAuto Recoveryを利用し、自動復旧を行う
        
        ### 自動復旧
        
        - ELBなどのロードバランサー配下のインスタンスにAuto Scalingを組み合わせて、ELBから定期的にヘルスチェックを行う。応答がない場合は切り離し、新たなインスタンスの追加。負荷が増えてきたら、新たなリソースを起動してロードバランサー配下に格納する。
        
        ### DB
        
        - RDSを使ってマルチAZ構造をとることが基本
        - マスターとスタンバイ構成になっていて、マスターが障害があれば、スタンバイがマスタに切り替わる。この処理をDNSの切り替えを利用する。

### スケーラブルなシステム

- クラウドは需要に応じて、リソースの量を増減することが簡単にできる。
- 水平方向の拡張性（スケールアウト）が可能な仕組みを考える。
- 増減するサーバに状態を持たないよう（ステートレス）にする
    - ElastiCacheを利用して一時的なメモリを確保する設計
    - DynamoDBを利用する場合もある。
- １つのリソースサイズを小さくする
    - リソースサイズが大きいと負荷が追加して負荷が大きいままになってしまう。

### キャパシティ推測が不要であること

- オンプレは用意した機器以上の性能を出すことはできないが、クラウドはリソース追加が簡単にできるので、キャパ推測の重要性は低下する。

- 水平方向の追加（スケールアウト）できるリソースは何か
- 垂直方向の追加（スケールアップ）できるリソースは何かを知る必要がある

- webサーバはスケールアウトが用意だがDBはスケールアウトは難しく、スケールアウトがメイン
    - DBサーバの一般的なスケーリング
        - 参照系と更新系DBを分ける
        - 参照系はリードレプリカを利用し、スケールアウト可能
        - 更新系はスケールアップして、処理性能を高める。
    - リードレプリカの上限は決まっている。Auroraはデフォルトでリードとライトのエンドポイントが用意されているため、RDSマルチAZ構に柔軟に対応することができる。

### 変更管理の自動化

- リソースの増減が簡単にできる。
- その恩恵を受けるためには追加したリソースが同じ設定、アプリケーション、データを持っていることが必要
- 構成管理の自動化はCloudFormation, AMI, OpsWorksを利用される。

Auto Scaling時のインスタンス構成

- AMIを最新状態に保つゴールデンマスター方式
- それ以外に、インスタンス起動時に最新のソースコンテンツを取得する
- サーバーからデータを排除して、NASのようにコンテンツを共有するEFSやFSxがある。

## パフォーマンスに優れたアーキテクチャ

```yaml
リソースを効率的に使用し、需要や技術の進化に合わせて効率的に利用すること
```

### リソースの選択

- コンピューティングリソース
    - インスタンス型
        - EC2やElastic Beacstalk
    - コンテナ型
        - ECS
    - 関数型
        - Lambda
        - 常駐的なリソースはインスタンス型やコンテナ型を利用する
        
        `関数型のリソースは非常駐的な場合に利用する。`
        
    

### ストレージリソース

- インスタンスに紐づいたブロックストレージの場合はEBSを利用する
- リソースをオブジェクト（ファイル単位）扱う場合はS3が最適
- スケーラビリティやコスト、耐久面ではS3の方が優位性がある

### データベースリソース

- 大量のデータの場合はRedshift
- KVSの場合はElasticCache

- それ以外の汎用NoSQLはDynamoDBを選択する
- RDBMSはAuroraとRDSがあるが、RDSの上位互換がAurora

### ネットワークリソース

- EC2にはネットワーク帯域の限界が定められている。CPUやメモリに余裕があるが、パフォーマンスが出ない場合は、インスタンスのネットワーク帯域の限界に達している場合がある。
- その場合は帯域が広いインスタンスタイプに変更する。
- インスタンスからEBSへのアクセスはボトルネックになりやすい。そのためEC2ではEBS最適化インスタンスが用意されている。通常のネットワーク経路とは別にEBS専用のネットワークを用意するオプションがある。

### リソースの確認とモニタリング

最適なリソースが使われているかを判断するためのモニタリングサービス（CloudWacth）

閾値を超えた場合にはCloudWacthを利用して、自動対処にSQSやLambdaを利用する

### トレードオフの判断

どこで処理を行うか決定すること。

データベースのキャッシュにはElastiCacheを利用し

コンテンツのキャッシュはCloudFrontを利用する。

Lambda

サーバを用意しなくてもプログラムを実行できる環境を提供するサービス

サーバーレスアーキテクチャ

コスト面や拡張性に優れている。

重要ポイント

```yaml
EC2は仮想サーバーを提供する
ECSはDocker コンテナの実行環境で提供する
Lambdaはサーバーなしでプログラムを実行する環境を構築する。
```
